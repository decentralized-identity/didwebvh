## `did:webvh` DID Method Specification

### Target System

The target system of the `did:webvh` DID method is the host (or domain)
name when the domain specified by the DID is resolved through the Domain Name
System (DNS) and verified by processing a log of DID versions.

### Method Name

The namestring that identifies this DID method is: `webvh`. A DID that uses this
method MUST begin with the following prefix: `did:webvh`. Per the DID
specification, this string MUST be in lowercase. The remainder of the DID, after
the prefix, is the [method-specific identifier](#method-specific-identifier),
specified below.

### Method-Specific Identifier

The `did:webvh` method-specific identifier contains both the [[ref:
self-certifying identifier]] (SCID) for the DID, and a fully qualified domain
name (with an optional path) that is secured by a TLS/SSL certificate. Given the
DID, a [transformation to an HTTPS URL](#the-did-to-https-transformation) is
performed such that the [[ref: DID Log]] for the `did:webvh` DID can be retrieved (via
an `HTTP GET`) and processed to produce the [[ref: DIDDoc]] for the DID. As per
the Augmented Backus-Naur Form (ABNF) notation below, the [[ref: SCID]] **MUST**
be the first element of the method-specific identifier.
  
Formal rules describing valid domain name syntax are described in
[[spec:RFC1035]], [[spec:RFC1123]], and [[spec:RFC2181]]. Each `did:webvh` DID's
globally unique [[ref: SCID]] **MUST** be
[generated](#scid-generation-and-verification) during the creation of the DID
based on its initial content and placed into the DID identifier for publication
and use.

The domain name element of the method-specific identifier MUST match the name
found in the SSL/TLS certificate per [[spec:RFC6125]] and the its replacement
[[spec:RFC9525]], and it MUST NOT include IP addresses. A port MAY be included
and the colon MUST be percent encoded to prevent a conflict with paths.
Directories and subdirectories MAY optionally be included, delimited by colons
rather than slashes.

As specified in the following Augmented Backus-Naur Form (ABNF) notation
[[spec:rfc2234]] the [[ref: SCID]] **MUST** be present in the DID string. See
examples below. The `domain-segment` and `path-segment` elements refer to
[[spec:rfc3986]]'s ABNF for a Generic URL (page 49). Attempting to replicate
here the full ABNF of those elements from that RFC would inevitably be wrong.

```abnf
webvh-did = "did:webvh:" scid ":" domain-segment 1+( "." domain-segment ) [ percent-encoded-port ] *( ":" path-segment )
scid = 46(base58-alphabet) ; The characters in the base58-btc-alphabet are as defined in the referenced W3C "Controller Documents" specification 
domain-segment = ; A part of a domain name as defined in RFC3986, such as "example" and "com" in "example.com"
percent-encoded-port = "%3A" ( "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9" ) 1*4( DIGIT )
path-segment= ; A part of a URL path as defined in RFC3986, such as "path", "to", "folder" in "path/to/folder"
```

The ABNF for a `did:webvh` is almost identical to that of `did:web`, with changes
only to the DID Method (`webvh` instead of `web`), and the addition of the
`<scid>:` (defined in the [SCID](#scid-generation-and-verification)) section of
this specification) element in `did:webvh` that is not in `did:web`. As specified
in the [DID-to-HTTPS Transformation](#the-did-to-https-transformation) section
of this specification, `did:webvh` and `did:web` DIDs that have the same fully
qualified domain and path transform to the same HTTPS URL, with the exception of
the final file -- `did.json` for `did:web` and `did.jsonl` for `did:webvh`. For
`did:webvh` DIDs using [[ref: witnesses]], another file `did-witness.json` is also
found (logically) beside the `did.jsonl` web server file. See the
[witnesses](#did-witnesses) section of this specification for details.

### The DID to HTTPS Transformation

The `did:webvh` [method-specific identifier](#method-specific-identifier) is
defined to enable a transformation of the DID to an HTTPS URL for publishing
and retrieving the [[ref: DID Log]]. This section defines the transformation
from DID to HTTPS URL, including a number of examples.

Given a `did:webvh`, the HTTPS URL for the [[ref: DID Log]] is generated by
carrying out the following steps. The steps are carried out by the [[ref: DID
Controller]] to determine where to publish the [[ref: DID Log]], and by all resolvers to
retrieve the [[ref: DID Log]].

1. Remove the literal `did:webvh:` prefix from the DID, leaving the method specific
   identifier.
2. Remove the [[ref: SCID]] by removing the text up to and including the first colon
   (`<scid>:`) from the method-specific identifier and continue processing.
3. Replace `:` with `/` in the method-specific identifier to obtain the fully
   qualified domain name and optional path.
4. If there is no optional path, append `/.well-known` to the URL.
   1. When this algorithm is used for resolving a DID path (such as
      `<did>/whois` or `<did>/path/to/file as defined in the section [DID URL
      Handling](#did-url-resolution)), the `/.well-known` **MUST NOT** be
      included in the HTTPS URL.
5. If the domain contains a port, percent decode the colon.
6. Generate an HTTPS URL to the expected location of the [[ref: DIDDoc]] by prepending
   `https://`.
7. Append `/did.jsonl` to complete the URL.
   1. If the DID is using [[ref: witnesses]], an extra JSON file containing the
      witness proofs for the [[ref: DID Log Entries]] must be published and
      retrieved during resolution. The URL for the extra file is defined by
      replacing the `/did.jsonl` at the end of the [[ref: DID Log]] URL with
      `/did-witness.json`.
   2. When this algorithm is used for resolving a DID path (such as
      `<did>/whois` or `<did>/path/to/file` as defined in the section [DID URL
      Handling](#did-url-resolution)), append the DID URL path instead.
8. The content type for the `did.jsonl` file **SHOULD** be `text/jsonl`.

The following are some examples of various DID-to-HTTPS transformations based
on the processing steps specified above.

::: example

`did:webvh` DIDs and the corresponding web locations of their `did:webvh` log file.
In the examples,`{SCID}` is a placeholder for where the generated [[ref: SCID]] will be
placed in the actual DIDs and HTTPS URLs. Note that when the `{SCID}` follows
the literal `did:webvh:` as a separate element, the `{SCID}` is not part of the
HTTPS URL.

---

domain/`did:web`-compatible

`did:webvh:{SCID}:example.com` -->

`https://example.com/.well-known/did.jsonl`

subdomain

`did:webvh:{SCID}:issuer.example.com` -->

`https://issuer.example.com/.well-known/did.jsonl`

path

`did:webvh:{SCID}:example.com:dids:issuer` -->

`https://example.com/dids/issuer/did.jsonl`

path w/ port

`did:webvh:{SCID}:example.com%3A3000:dids:issuer` -->

`https://example.com:3000/dids/issuer/did.jsonl`

:::

The location of the `did:webvh` `did.jsonl` [[ref:DID Log]] file is the same as
where the comparable `did:web`'s `did.json` file is published. A [[ref: DID
Controller]] **MAY** publish both DIDs and so, both files. The process
to do so is described in the [publishing a parallel `did:web`
DID](#publishing-a-parallel-didweb-did) section of this specification.

### The DID Log File

The [[ref: DID log]] file contains a list of [[ref: entries]], one for each version of the DID. A
version of the DID is an update to the contents of the resolved [[ref: DIDDoc]] for the
DID, and/or a change to the [[ref: parameters]] that control the generation and
verification of the DID.

Each entry is a JSON object consisting of the following properties.

`{ "versionId": "", "versionTime": "", "parameters": {}, "state": {}, "proof" : [] }`

1. The value of `versionId` **MUST** be a string consisting of the DID version number
   (starting at `1` and incrementing by one per DID version), a literal dash
   `-`, and the `entryHash`, a hash calculated across the [[ref: log entry]]
   content. The input to the hash is chosen so as to link each entry to its
   predecessor in a ledger-like chain. The input to the hash is specified in the
   [Entry Hash Generation and
   Verification](#entry-hash-generation-and-verification) section of this
   specification.
2. The value of `versionTime` **MUST** be a timestamp in UTC of the entry in [[ref:
   ISO8601]] format, as asserted by the [[ref: DID Controller]]. The timestamp
   **MUST** be the time the DID will be retrieved by a [[ref: witness]] or resolver,
   or before.
3. The JSON object `parameters` contains the configurations/options set by the
   [[ref: DID Controller]] to be used in the processing of current and future
   [[ref: log entries]]. Permitted `parameters` are defined in the [`did:webvh`
   DID Method Parameters](#didwebvh-did-method-parameters) section of this
   specification.
4. The JSON object `state` contains the [[ref: DIDDoc]] for this version of the
   DID.
5. The JSON array `proof` contains a [[ref: Data Integrity]] proof created for
   the entry and signed by a key authorized to update the [[ref: DIDDoc]].

After creation, each entry has (per the [[ref JSON Lines]] specification) all
extra whitespace removed, a `\n` character appended, and the result added to
the [[ref: DID Log]] file for publication.

A more comprehensive description of how to create and update a [[ref: DID log
entry]] is given in steps 4 - 6 of the [create DID](#create-register) section.

Examples of [[ref: DID Logs]] and [[ref: DID log entries]] can be found in the
[Examples] section on the `did:webvh` information website.

[Examples]: https://didwebvh.info/latest/example/

### DID Method Operations

#### Create (Register)

Creating a `did:webvh` DID is done by carrying out the following steps.

1. **Define the DID string**
   The start of the DID **MUST** be the literal string "`did:webvh:{SCID}:`", where the `{SCID}` is
   a placeholder that will be replaced by the calculated [[ref: SCID]] later in the process (see step
   5). This first part of the DID string is followed by a fully qualified domain name
   (with an optional path) that is secured by a TLS/SSL certificate and
   reflects the web location at which the [[ref: DID Log]] (`did.jsonl`) will be published

   The DID **MUST** be a valid `did:webvh` DID as per the ABNF of a `did:webvh` DID defined
   in the [Method-Specific  Identifier](#method-specific-identifier) section of this specification.

   1. Note: the [[ref: SCID]] for a `did:webvh` DID is not by default in the HTTPS
      URL for the DID. A [[ref: DID Controller]] **MAY** include the [[ref:
      SCID]] in the HTTPS URL by inserting additional placeholder `{SCID}`
      strings into the domain name or path components of the method-specific
      identifier when creating the DID. Additional instance(s) of the [[ref:
      SCID]] in the domain and/or path parts of the DID does not alter the
      [DID-to-HTTPS transformation](#the-did-to-https-transformation).

2. **Generate the authorization key pair(s)**
   [Authorized keys](#authorized-keys) are authorized to control (create, update, deactivate) the DID.
   At the same time, generate any other key pairs that will be placed into the initial
   [[ref: DIDDoc]] for the DID.

   1. If the DID is to use [[ref: pre-rotation]], additional key generation will
      be necessary to generate the required "next" authorization keys and their
      corresponding [[ref: pre-rotation]] hashes.
   2. For each authorization key pair, generate a [[ref: multikey]] based on the
      key pair's public key. The [[ref: multikey]] representations of the public
      keys are placed in the `updateKeys` property in [[ref: parameters]].
   3. The public key(s) of the authorization key pair(s) **MAY** be used in the
      [[ref: DIDDoc]] as well, but that is not required.

3. **Create the initial [[ref: DIDDoc]] for the DID**
   The [[ref: DIDDoc]] **MUST** contain the top level `id` property which **MUST** be the DID string from
   step 1, including the placement of the `{SICD}` placeholder for the [[ref: SCID]]. Other
   [[ref: DIDDoc]] verifications **SHOULD** be performed.

   All other absolute reference's to the DID in the [[ref: DIDDoc]] must use the form defined
   in step 1, with the identified placeholder for the [[ref: SCID]] (e.g., `did:webvh:{SCID}:example.com#key-1`,
   `did:webvh:{SCID}:example.com:dids:issuer#key-1`, etc.).

   The [[ref: DIDDoc]] can contain any other content as deemed necessary by the [[ref: DID Controller]].

   1. Note: The placeholder (the string `{SCID}`) **MUST** be in every place in the [[ref: DIDDoc]] where
   the [[ref: SCID]] is to be placed.

4. **Generate a preliminary DID Log Entry** JSON object containing the same JSON
   properties that will be in the published [[ref: DID log entry]], but with some
   values preset, pending calculation of the [[ref: SCID]] and [[ref entryHash]] and
   without the `proof`.

   1. The value of `versionId` string **MUST** be the placeholder literal `"{SCID}"`.
   2. The value of `versionTime` string **MUST** be a valid UTC [[ref: ISO8601]] date/time string,
   and the represented time **MUST** be before or equal to the current time.
   3. The value of the `parameters` property **MUST** be a JSON object defined at the
      discretion of the [[ref: DID Controller]]. The properties in this nested JSON object
      **MUST** be as permitted in the [DID Generation and Verification
      Parameters](#didwebvh-did-method-parameters) section of this specification,
      and all required values in the first version of the DID **MUST** be
      present. In addition, where the [[ref: SCID]] of the DID is referenced in
      the parameters, the placeholder literal string `{SCID}` **MUST** be used
      in place of the to-be-calculated [[ref: SCID]].
   4. The value of the `state` property **MUST** be the initial [[ref: DIDDoc]] as
      defined in the previous step 3 of this process.

5. **Update the preliminary DID Log Entry to the initial DID Log Entry**
   Use the preliminary [[ref: DID log entry]] to perform the consecutive steps:

   1. **Calculate the [[ref: SCID]]**
   The preliminary JSON object **MUST** be used to calculate the [[ref: SCID]] for the DID as defined in
   the [SCID Generation and Verification](#scid-generation-and-verification) section of this
   specification.
   2. **Replace the placeholder `{SCID}`** Replace throughout the preliminary
   JSON object the placeholder "`{SCID}`" with the calculated [[ref: SCID]] from
   the previous step.
   3. **Calculate the [[ref: Entry Hash]]**
   The preliminary JSON object updated in the previous step **MUST** be used to calculate the [[ref: Entry Hash]]
   (`entryHash`) for the [[ref: log entry]], as defined in the
   [Entry Hash Generation and Verification](#entry-hash-generation-and-verification) section of
   this specification.
   4. **Replace the preliminary `versionId` value** The value of the `versionId`
   property **MUST** be updated with the literal string `1` (for version number 1),
   a literal `-`, followed by the `entryHash` value calculated in the previous
   step.
   5. **Generate the [[ref: Data Integrity]] proof** A [[ref: Data Integrity]]
   proof on the preliminary JSON object as updated in the previous step **MUST**
   be generated using an authorized key in the required `updateKeys` property in the
   [[ref: parameters]] object.

   6. **Add the [[ref: Data Integrity]] proof** The [[ref Data Integrity]] proof
   is added to the preliminary JSON object. The resultant JSON object is the
   initial [[ref: DID log entry]] for the DID.

6. **Generate the first [[ref: JSON Line]]**
   The [[ref: DID log entry]] **MUST** be updated to be a [[ref: JSON Lines]]
   entry by removing extraneous white space and appending a carriage return,
   and the result stored as the contents of the file `did.jsonl`.

   If the [[ref: DID Controller]] has opted to use [[ref: witnesses]] for the
   DID, the required proofs from the DID's [[ref: witnesses]] **MUST** be
   collected and published in the `did-witness.json` file before the [[ref: DID
   Log]] with the new version is published. See the [DID
   Witnesses](#did-witnesses) section of this specification.

7. **Publish the [[ref: DID Log]]**
   The complete [[ref: DID Log]] file **MUST** be published at the appropriate
   Web location defined by the `did:webvh` DID identifier (see step 1)
     - This is a logical operation -- how a deployment serves the `did.jsonl`
       content is not constrained.
     - Use the [DID-to-HTTPS Transformation](#the-did-to-https-transformation)
       steps to transform the DID into the Web location of the [[ref: DID Log]]
       file.

A controller **MAY** generate an equivalent `did:web` [[ref: DIDDoc]] and publish it as
defined in the
[Publishing a Parallel `did:web` DID](#publishing-a-parallel-didweb-did) section
of this specification. The `did:web` [[ref: DIDDoc]] could be used for backwards
compatibility as a transition is made from `did:web` to `did:webvh`. Verifiers
using the `did:web` lose the verifiable properties and history of the `did:webvh`
for the convenience of the simple retrieval of the `did:web` [[ref: DIDDoc]].

#### Read (Resolve)

The following steps MUST be executed to resolve the [[ref: DIDDoc]] for a `did:webvh` DID:

1. The [DID-to-HTTPS Transformation](#the-did-to-https-transformation) steps
   **MUST** be used to transform the DID into an HTTPS URL for the [[ref: DID
   Log]] file.
2. Perform an HTTPS `GET` request to the URL using an agent that can successfully
   negotiate a secure HTTPS connection, which enforces the security requirements
   as described in
   [Security and privacy considerations](#security-and-privacy-considerations).
3. When performing the DNS resolution during the HTTPS GET request, the client
   SHOULD utilize [[spec:rfc8484]] in order to prevent tracking of the identity
   being resolved.
4. The [[ref: DID Log]] file **MUST** be processed as described below.

To process the retrieved [[ref: DID Log]] file, the resolver **MUST** carry out
the following steps on each of the [[ref: log entries]] in the order they appear in the
file, applying the [[ref: parameters]] set from the current and previous
entries. As noted in the [DID Log File](#the-did-log-file) section, [[ref: log entries]]
are each a JSON object with the following properties:

   1. `versionId`
   2. `versionTime`
   3. `parameters`
   4. `state` -- the version's [[ref: DIDDoc]].
   5. `proof` -- a [[ref: Data Integrity]] proof for the [[ref: log entry]].

For each entry:

1. Update the currently active [[ref: parameters]] with the [[ref: parameters]]
   from the entry (if any). The `parameters` **MUST** adhere to the [`did:webvh`
   DID Method Parameters](#didwebvh-did-method-parameters) section of this
   specification. Continue processing using the now active set of [[ref:
   parameters]].
   - While all [[ref: parameters]] in the first [[ref: Log Entry]] take effect
     immediately, some kinds of [[ref: parameters]] defined in later [[ref:
     entries]] only take effect *after* that entry has been published. For
     example, updating the `nextKeys` and `witnesses` arrays take effect only
     *after* the entry in which they are defined has been published.
2. The [[ref: Data Integrity]] proof in the entry **MUST** be valid and signed by
   an authorized key as defined in the [Authorized Keys](#authorized-keys)
   section of this specification.
   1. If the [[ref: DID Controller]] has opted to use [[ref: witnesses]]
      resolvers **MUST** retrieve and verify the DID's `did-witness.json` file. For
      details, see the [DID Witnesses](#did-witnesses) section of this
      specification.
3. Verify the `versionId` for the entry. The `versionId` is the
   concatenation of the version number, a dash (`-`), and the `entryHash`.
   1. The version number **MUST** be `1` for the the first [[ref: log entry]] and **MUST** be
      incremented by one for each subsequent [[ref: log entry]].
   2. A dash `-` **MUST** follow the version number.
   3. The `entryHash` **MUST** follow the dash, and **MUST** be verified using
      the process defined in the [Entry Hash Generation and
      Verification](#entry-hash-generation-and-verification) section of this
      specification.
4. The `versionTime` **MUST** be a valid UTC [[ref: ISO8601]] date/time string. The
   `versionTime` for each [[ref: log entry]] **MUST** be greater than the
   previous entry's time. The `versionTime` of the last entry **MUST** be
   earlier than the current time.
5. When processing the first [[ref: DID log]] entry, verify the [[ref: SCID]]
   (defined in the [[ref: parameters]]) according to the
   [SCID Generation and Verification](#scid-generation-and-verification) section
   of this specification.
6. Get the value of the [[ref: log entry]] property `state`, which is the [[ref:
   DIDDoc]] for the version.
7. If [[ref: Key Pre-Rotation]] is being used, the hash of all `updateKeys` entries
   in the `parameters` property **MUST** match a hash in
   the array of `nextKeyHashes` [[ref: parameter]] from the previous [[ref: DID log]]
   entry, with exception of the first entry, as defined in the
   [Key [[ref: Pre-Rotation]] Hash Generation and Verification](#pre-rotation-key-hash-generation-and-verification)
   section of this specification.
8. As each [[ref: log entry]] is processed and verified, collect the following information
   about each version:
      1. The [[ref: DIDDoc]].
      2. The `versionId` of the [[ref: DIDDoc]].
      3. The UTC `versionTime`of the [[ref: DIDDoc]].
      4. The latest list of active [[ref: multikey]] formatted public keys
         authorized to update the DID, from the `updateKeys` lists in the
         [[ref: parameters]].
      5. If [[ref: pre-rotation]] is being used, the hashes of authorized keys that must
         be used in the `updateKeys` list of the next [[ref: DID log]] entry. The [[ref: pre-rotation]] hashes are in the
         `nextKeyHashes` list in the [[ref: parameters]].
      6. All other `did:webvh` processing configuration settings as defined by in the
         `parameters` object.
9.  If the `parameters` for any of the versions define that some or all of
  the [[ref: DID Log entries]] must be witnessed, further verification of
  the [[ref: witness]] proofs must be carried out, as defined in the [DID
  Witnesses](#did-witnesses) section of this specification.
10.  If any of the DID verifications outlined in this process fail, discard the
    DID as invalid with an error message.

On completing the processing and successful verification of all [[ref: entries]] in the
[[ref: DID Log]], respond to the DID resolution request, including the
application of DID query [[ref: parameters]] such as `?versionId=` and `?versionTime=` with
the appropriate [[ref: DIDDoc]] version and content.

The following error codes and descriptions may be returned when resolving a DID.

:::todo

Document the full list of error codes that can be generated in resolving a DID.

:::

- Code 404: The `did:webvh` [[ref: DID Log]] file `did.jsonl` was not found.

##### Reading did:webvh DID URLs

A `did:webvh` resolver **MUST** resolve the [[spec:DID-Core]] `versionId` and
`versionTime` DID URL query parameters. The `versionId` query argument value
**MUST** match the full `versionId` from a [[ref: DID Log entry]] for the
resolver to return that version of the DIDDoc. If a [[ref: DID Log entry]] with
that `versionId` is not found, a `NotFound` **MUST** be returned. A specified
time in [[ref: ISO8601]] format as the query argument for `versionTime` **MUST**
return the DIDDoc from the [[ref: DID Log entry]] that was active at that time,
if any. If the DID was not active at the specified time, a `NotFound` **MUST**
be returned.

A `did:webvh` resolver **SHOULD** resolve the DID URL query parameter
`versionNumber` with an integer value if there is a [[ref: DID Log entry]] with
a `versionId` with a matching integer prior to the literal `-` -- the
`versionNumber` for that [[ref: DID Log entry]] as defined in the process for
setting the `versionId` in the [creating the DID](#create-register) section of
this specification. The `versionNumber` query parameter is not in the
[[spec:DID-Core]] specification.

A `did:webvh` resolver **MAY** implement the resolution of the `/whois` and a DID
URL Path using the [whois LinkedVP Service](#whois-linkedvp-service) and 
[DID URL Path Resolution Service](#did-url-path-resolution-service) as defined in
this specification by processing the [[ref: DID Log]] and then dereferencing the
DID URL based on the contents of the [[ref: DIDDoc]]. The client of a resolver that does
not implement those capabilities must use the resolver to resolve the
appropriate [[ref: DIDDoc]], and then process the resulting DID URLs themselves. Since
the default DID-to-HTTPS URL transformation is trivial, `did:webvh`
[[ref: DID Controllers]] are strongly encouraged to use the default behavior
for DID URL Path resolution.

#### Update (Rotate)

To update a DID, a new, verifiable [[ref: DID Log Entry]] must be generated,
witnessed (if necessary), appended to the existing [[ref: DID Log]] (`did.jsonl`),
and published to the web location defined by the DID. The process to generate a
verifiable [[ref: DID Log Entry]] follows a similar process to the
[Create](#create-register) process, as follows:

1. Make the desired changes to the [[ref: DIDDoc]]. While the contents of a new DIDDoc
   version are (mostly) up to the [[ref: DID controller]], there are some limitations:
   1. If the DID is configured to support [[ref: portability]], the root `id`
      property in the [[ref: DIDDoc]] **MAY** be changed when the [[ref: DID Controller]] wants to (or
      is forced to) publish the DID at a different Internet location and wants
      to retain the [[ref: SCID]] and history of the DID. For details, see the
      [DID Portability](#did-portability) section of this specification.
2. Define the [[ref: parameters]] JSON object to include the properties that affect the evolution of the
   DID. The `parameters` **MUST** be from those listed in the [`did:webvh` DID
   Method Parameters](#didwebvh-did-method-parameters) section of this
   specification. Any [[ref: parameters]] defined in the JSON object override the
   previously active value, while any [[ref: parameters]] not included imply the
   existing values remain in effect. If no changes to the [[ref: parameters]]
   are needed, an empty JSON object `{}` **MUST** be used.
   - While all [[ref: parameters]] in the first [[ref: Log Entry]] take effect
     immediately, some types of [[ref: parameters]] defined in later [[ref: entries]] only take
     effect after the entry has been published. For example, rotating the keys
     authorized to update a DID or changing the [[ref: witnesses]] for a DID take effect
     only *after* the entry in which they are defined has been published.
3. Generate a preliminary [[ref: DID log entry]] JSON object containing the following properties:
   1. The value of `versionId` **MUST** be the value of `versionId` from the *previous* [[ref: DID log entry]].
   2. The `versionTime` value **MUST** be a string that is an [[ref: ISO8601]]
      format UTC timestamp. The time **MUST** be greater than the time of the
      previous [[ref: log entry]], and **MUST** be the time the DID will be
      retrieved by a [[ref: witness]] or resolver, or before.
   3. The [[ref: parameters]] passed in as a JSON object.
   4. Set the `state` JSON object to be the new version of the [[ref: DIDDoc]].
4. Calculate the new `versionId` of the new [[ref: DID Log Entry]], including
   incrementing the version number integer and using the process described in
   the [Entry Hash Generation and Verification](#entry-hash-generation-and-verification)
   section of this specification.
5. Replace the value of the `versionId` property in the preliminary [[ref: DID Log
   Entry]] with the value produced in the previous step.
6. Generate a [[ref: Data Integrity]] proof on the [[ref: DID log entry]] using
   an authorized key, as defined in the [Authorized Keys](#authorized-keys)
   section of this specification.
7. If [[ref: Key Pre-Rotation]] is being used, the hash of all `updateKeys` entries
   in the `parameters` property **MUST** match a hash in
   the array of `nextKeyHashes` [[ref: parameter]] from the previous [[ref: DID log]] entry with exception of the first entry, as defined in the
   [Key [[ref: Pre-Rotation]] Hash Generation and Verification](#pre-rotation-key-hash-generation-and-verification)
   section of this specification.
8. The proof JSON object **MUST** be added as the value of the `proof` property in the [[ref: log entry]].
9. The entry **MUST** be made a [[ref JSON Line]] by removing extra whitespace, adding a `\n`
   to the entry. 
10. If the [[ref: DID Controller]] has opted to use [[ref: witnesses]] for the
   DID, the [[ref: DID Controller]] **MUST** collect the [[ref: threshold]] of proofs
   from the DID's [[ref: witnesses]], and update and publish the DID's
   `did-witness.json` file. The updated `did-witness.json` file **MUST** be published
   **BEFORE** the updated [[ref: DID Log]] file is published. See the [DID
   Witnesses](#did-witnesses) section of this specification.
11. The new [[ref: log entry]] **MUST** be appended to the existing contents of
    the [[ref: DID Log]] file `did.jsonl`.
12. The updated [[ref: DID Log]] file **MUST** be published the appropriate
    location defined by the `did:webvh` identifier.
    - This is a logical operation -- how a deployment serves the `did.jsonl`
    content is not constrained.

A controller **MAY** generate an equivalent, updated `did:web` [[ref: DIDDoc]] and
publish it as defined in the
[Publishing a Parallel `did:web` DID](#publishing-a-parallel-didweb-did)
section of this specification.

#### Deactivate (Revoke)

To deactivate the DID, the [[ref: DID Controller]] **MUST** add to the [[ref:
DID log entry]] [[ref: parameters]] the property name and value `"deactivated":
true`. A [[ref: DID Controller]] **SHOULD** update the [[ref: DIDDoc]] and
`parameters` object to further indicate the deactivation of the DID, such as
setting to `null` the `updateKeys` in the [[ref: parameters]], preventing
further versions of the DID. If the DID is using [[ref: pre-rotation]], two
[[ref: DID log entries]] are required, the first to stop the use of
pre-rotation, and the second for setting `updateKeys` to `null`. For additional
details about turning off [[ref: pre-rotation]] see the
[pre-rotation](#pre-rotation-key-hash-generation-and-verification) section of
this specification.

A resolver encountering in the [[ref: DID log entry]] [[ref: parameters]] the
property key:value pair `"deactivated": true` **MUST** return in the [[ref:
DIDDoc]] Metadata the property key:value `"deactivated": true`, as per the
[[spec:DID-RESOLUTION]] specification.

### DID Method Processes

The [DID Method Operations](#did-method-operations) reference several processes
that are executed during [[ref: DIDDoc]] generation and DID resolution verification. Each
of those processes is specified in the following sections.

#### `did:webvh` DID Method Parameters

Entries in the `did:webvh` [[ref: DID Log]] contain the JSON object `parameters`
that define the DID processing [[ref: parameters]] being used by the [[ref: DID
Controller]] when publishing the current and subsequent [[ref: DID log
entries]]. A DID Resolver **MUST** use the same [[ref: parameters]] when
processing the [[ref: DID Log]] to resolve the DID. The `parameters` object
**MUST** only include properties defined in this specification.

::: example

An example of the JSON prettified `parameters` property in the first [[ref: DID Log]] entry for a DID:

``` json
{
    "prerotation": true,
    "portable": false,
    "updateKeys": [
      "z82LkqR25TU88tztBEiFydNf4fUPn8oWBANckcmuqgonz9TAbK9a7WGQ5dm7jyqyRMpaRAe"
    ],
    "nextKeyHashes": [
      "enkkrohe5ccxyc7zghic6qux5inyzthg2tqka4b57kvtorysc3aa"
    ],
    "method": "did:webvh:0.3",
    "scid": "{SCID}"
}
```

:::

The allowed [[ref: parameter]] properties and (where applicable) enumerated values for those
properties are defined below.

- `method`: Defines the `did:webvh` specification version to use when processing a
  given DID's log file. As new versions of this specifications are defined,
  additional [[ref: parameters]] and enumerated values will be associated with
  the `method` values. This allows a long lasting DID to evolve the settings
  being used by the DID over time, such as changing the hash algorithms
  permitted, or allowing other [[ref: Data Integrity]] cryptosuites.
  - This property **MUST** appear in the first [[ref: DID log entry]].
  - This property **MAY** appear in later [[ref: DID log entries]] to indicate that
    the processing rules for that and later [[ref: log entries]] have been changed to a
    different specification version.
  - Acceptable values for this specification are:
    - `did:webvh:0.5`: Requires that the rules defined in this version of the specification be used
      in processing the log. Implied by the value are the following:
      - The permitted hash algorithms used by the [[ref: DID Controller]] **MUST** be `SHA-256` as defined in [[spec:rfc6234]].
      - The permitted [[ref: Data Integrity]] cryptosuites used by the [[ref: DID Controller]] **MUST** be `eddsa-jcs-2022` as referenced in [spec:di-eddsa-v1.0].
- `scid`: The value of the [[ref: SCID]] for this DID.
  - This property **MUST** appear in the first [[ref: DID log entry]].
- `updateKeys`: An array of [[ref: multikey]] formatted public keys
  associated with the private keys that are authorized to sign the log entries
  that update the DID from one version to the next. An instance of the list in
  an entry replaces the previously active list. If an entry does not have the
  `updateKeys` property, the currently active list continues to apply. See the
  [Authorized Keys](#authorized-keys) section of this specification for
  additional details.
  - This property **MUST** appear in the first [[ref: DID log entry]] and **MAY**
    appear in subsequent entries, at the discretion of the
    [[ref: DID Controller]].
  - A key from the `updateKeys` array in the first [[ref: DID log entry]]
    **MUST** be used to authorize the initial [[ref: log entry]]. In all other
    [[ref: DID log entries]] without the [[ref: Key Pre-Rotation]] feature, an `updateKeys` property becomes active *after* the
    publication of its entry -- meaning its [[ref: log entry]] **MUST** be
    signed by a key the most recent `updateKeys` list from a **prior** [[ref:
    DID log]] entry. In [[ref: DID log entries]] with the [[ref: Key Pre-Rotation]] feature, an `updateKeys` property becomes 
    active *before* the publication of its entry -- meaning its [[ref: log entry]] **MUST** be
    signed by a key the `updateKeys` list from the **current** [[ref:
    DID log]] entry.
  - `updateKeys` **SHOULD** be set to `null` when deactivating the DID. See the
    [deactivate](#deactivate-revoke) section of this specification for more
    details.
  - `updateKeys` **MUST** have at least 1 entry and **MUST NOT** be set to an empty list `[]`.
- `portable`: A boolean (`true` / `false`) indicating if the DID is portable and
  thus can be renamed to change the Web location of the DID.
  - The value can **ONLY** be set to `true` in the first [[ref: log entry]], the initial version of the DID.
  - If not explicitly set in the first [[ref: log entry]], it **MUST** be set to `false`.
  - Once the value has been explicitly set to `false` in a [[ref: DID log entry]], it **MUST NOT** be set back to `true`.
  - See the section of this specification on [DID Portability](#did-portability)
    for more details about renaming a `did:webvh` DID.
- `nextKeyHashes`: An array of strings that are hashes of [[ref: multikey]]
  formatted public keys that **MAY** be added to the `updateKeys` list in the next
  [[ref: log entry]]. At least one entry of `nextKeyHashes` **MUST** be added to the next `updateKeys` list.
  - The process for generating the hashes and additional details for using [[ref: pre-rotation]] are defined in the
    [Pre-Rotation Key Hash Generation and Verification](#pre-rotation-key-hash-generation-and-verification)
    section of this specification.
  - If not explicitly set in the first [[ref: DID Log entry]], its value **MUST** be `null`.
  - Once the [[ref: parameter]] `nextKeyHashes` has been set to a non-empty
    list, the [[ref: Key Pre-Rotation]] feature becomes active. While active the
    properties `nextKeyHashes` and `updateKeys` **MUST** be present in all
    [[ref: DID log entry]].
  - All [[ref: multikey]] formatted public keys added in a new `updateKeys` list **MUST** have their
    hashes listed in the `nextKeyHashes` list from the previous [[ref: DID log entry]].
  - A [[ref: DID Controller]] **MAY** put extra strings in the `nextKeyHashes`
    array that are not subsequently used in an `updateKeys` entry.
  - Any unused hashes in the prior `nextKeyHashes` are ignored.
  - The value of `nextKeyHashes` **MAY** be set to `null` to deactivate
    pre-rotation. For additional details about turning off [[ref: pre-rotation]]
    see the [pre-rotation](#pre-rotation-key-hash-generation-and-verification)
    section of this specification.
  - `nextKeyHashes` **MUST** have at least 1 entry and **MUST NOT** be set to an empty list `[]`.
- `witness`: A JSON object containing the [[ref: parameters]] for declaring the witnesses
  for the DID, and the [[ref: parameters]] for the process of updating a DID via a
  collaboration with [[ref: witnesses]] prior to publication. For details of
  this data and its usage in the approvals process, see the
  [DID Witnesses](#did-witnesses) section of this specification.
  - A `witness` property in the first [[ref: DID log entry]] is immediately
    "active" and used to define the [[ref: witnesses]] and necessary [[ref: threshold]]
    for witnessing the initial [[ref: log entry]]. In all other [[ref: DID log entries]],
    a `witness` property becomes active **after** the publication of its entry
    -- meaning its [[ref: log entry]] **MUST** be witnessed by active
    `witnesses` from a **prior** [[ref: DID log]] entry.
  - If the `witness` property is not set in the first [[ref: DID log entry]],
    its value **MUST** be null.
  - `witness` **MUST** have at least 1 entry and **MUST NOT** be set to an empty list `[]`.
- `deactivated`: A JSON boolean that **MUST** be initialized to `false` and
  **SHOULD** be set to `true` when the DID is to be deactivated but remains
  resolvable. See the [deactivate (revoke)](#deactivate-revoke) section of this
  specification for more details.
- `ttl`: A number, the number of seconds that a cache entry for a resolved
  `did:webvh` DID **SHOULD** last, as recommended by the [[ref: DID
  Controller]]. A resolver can use this value in deciding whether to retrieve a
  new version of the DID's `did.jsonl` file. If not specified, its value
  **MUST** be `null` and resolvers **MAY** set a default based on the business
  needs of the resolver clients.
  - Caching a `did:webvh` can be valuable in places where the business rules
    require resolving a number of DID URLs for the same DID. For example, a
    client might want call the resolver to the current [[ref: DIDDoc]], and then make
    repeated calls to get all of the previous versions of the [[ref: DIDDoc]]. By caching
    the [[ref: DIDDoc]] state, the resolver would not have to retrieve and process the
    [[ref: DID Log]] on each call.
  - A Web Server handling one or more `did.jsonl` files **MAY** be configured to
   use a comparable HTTP TTL per [[spec-inform:rfc9111]].

#### SCID Generation and Verification

The [[ref: self-certifying identifier]] or `SCID` is a required [[ref: parameter]] in the
first [[ref: DID log entry]] and is the hash of the DID's inception event.

##### Generate SCID

To generate the [[ref: SCID]] for a `did:webvh` DID, the DID Controller
**MUST** execute the following function:

 `base58btc(multihash(JCS(preliminary log entry with placeholders), <hash algorithm>))`

Where:

1. The `preliminary [[ref: log entry]] with placeholders` consists of the following
   pre-publication JSON object of what will become the first [[ref: log entry]]. The
   placeholder is the literal string "`{SCID}`".

   - The `versionId` entry, which **MUST** be `{SCID}`.
   - The `versionTime` entry, which **MUST** be a string that is the current time in
         UTC [[ref: ISO8601]] format, e.g., `"2024-04-05T07:32:58Z"`
   - The complete `parameters` for the initial [[ref: log entry]] as defined by the
     [[ref: DID Controller]], with the placeholder wherever the [[ref: SCID]] will
     eventually be placed.
   - The `state` JSON object with the value being the initial [[ref: DIDDoc]]
     with placeholders (the literal string "`{SCID}`") wherever the [[ref:
     SCID]] will eventually be placed in the [[ref: DIDDoc]].

2. `JCS` is an implementation of the [[ref: JSON Canonicalization Scheme]]
   [[spec:rfc8785]]. It outputs a canonicalized representation of its JSON
   input.
3. `multihash` is an implementation of the [[ref: multihash]] specification. Its
   output is a hash of the input using the associated `<hash algorithm>`,
   prefixed with a hash algorithm identifier and the hash size.
4. `<hash algorithm>` is the hash algorithm used by the [[ref: DID Controller]].
   The hash algorithm **MUST** be one listed in the
   [parameters](#didwebvh-did-method-parameters) defined by the version of the
   `did:webvh` specification being used by the [[ref: DID Controller]].
5. `base58btc` is an implementation of the [[ref: base58btc]] function.
   Its output is the base58 encoded string of its input.

##### Verify SCID

To verify the [[ref: SCID]] of a `did:webvh` DID being resolved, the resolver
**MUST** execute the following process:

1. Extract the first [[ref: DID log entry]] and use it for the rest of the steps
   in this process.
2. Extract the `scid` property value from the [[ref: parameters]] in the [[ref: DID log entry]].
3. Determine the hash algorithm used by the [[ref: DID Controller]] from the [[ref: multihash]] `scid` value.
   - The hash algorithm **MUST** be one listed in the
   [parameters](#didwebvh-did-method-parameters) defined by the version of the
   `did:webvh` specification being used by the [[ref: DID Controller]] based on the
   `method` [[ref: parameters]] property.
4. Remove the [[ref: data integrity]] proof property from the [[ref: DID log entry]].
5. Replace the `versionId` property value with the literal `"{SCID}"`.
6. Treat the resulting [[ref: log entry]] as a string and do a text replacement of the `scid`
   value from Step 2 with the literal string `{SCID}`.
7. Use the result and the hash algorithm (from Step 3) as input to the function
   defined in the [Generate SCID](#generate-scid) section (above).
8. The output string **MUST** match the `scid` extracted
   in Step 2. If not, terminate the resolution process with an error.

#### Entry Hash Generation and Verification

The `entryHash` follows the version number and dash character `-` in the
`versionId` property in each DID log entry. Each `entryHash` is calculated
across its [[ref: log entry]], excluding the [[ref: Data Integrity]] proof. The
`versionId` used in the input to the hash is a predecessor value to the current
[[ref: log entry]], ensuring that the [[ref: entries]] are cryptographically "chained"
together in a microledger. For the first [[ref: log entry]], the predecessor
`versionId` is the SCID (itself a hash), while for all other entries it is the
`versionId` property from the previous log entry.

##### Generate Entry Hash

To generate the required hash for a `did:webvh` [[ref: log entry]], the [[ref: DID Controller]]
**MUST** execute the process `base58btc(multihash(JCS(entry), <hash algorithm>))` given a
preliminary [[ref: log entry]] as the string `entry`, where:

1. `JCS` is an implementation of the [[ref: JSON Canonicalization Scheme]]
   ([[spec:rfc8785]]). Its output is a canonicalized representation of its
   input.
2. `multihash` is an implementation of the [[ref: multihash]] specification. Its
   output is a hash of the input using the associated `<hash algorithm>`,
   prefixed with a hash algorithm identifier and the hash size.
3. `<hash algorithm>` is the hash algorithm used by the [[ref: DID Controller]].
   The hash algorithm **MUST** be one listed in the
   [parameters](#didwebvh-did-method-parameters) defined by the version of the
   `did:webvh` specification being used by the [[ref: DID Controller]].
4. `base58btc` is an implementation of the [[ref: base58btc]] function.
   Its output is the base58 encoded string of its input.

The following is an example of a preliminary [[ref: log entry]] that is processed to
produce an [[ref: entry hash]]. As this is a first entry in a [[ref: DID Log]], the input
`versionId` is the [[ref: SCID]] of the DID.

```json
{"versionId": "QmfGEUAcMpzo25kF2Rhn8L5FAXysfGnkzjwdKoNPi615XQ", "versionTime": "2024-09-26T23:22:26Z", "parameters": {"prerotation": true, "updateKeys": ["z6MkhbNRN2Q9BaY9TvTc2K3izkhfVwgHiXL7VWZnTqxEvc3R"], "nextKeyHashes": ["QmXC3vvStVVzCBHRHGUsksGxn6BNmkdETXJGDBXwNSTL33"], "method": "did:webvh:0.5", "scid": "QmfGEUAcMpzo25kF2Rhn8L5FAXysfGnkzjwdKoNPi615XQ"}, "state": {"@context": ["https://www.w3.org/ns/did/v1"], "id": "did:webvh:QmfGEUAcMpzo25kF2Rhn8L5FAXysfGnkzjwdKoNPi615XQ:domain.example"}}
```

Resulting [[ref: entryHash]]: `QmQq6Kg4ZZ1p49znzxnWmes4LkkWgMWLrnrfPre8UD56bz`

##### Verify The Entry Hash

To verify the `entryHash` for a given  `did:webvh` [[ref: DID log entry]], a DID
Resolver **MUST** execute the following process:

1. Extract the `versionId` in the [[ref: DID log entry]], and
   remove from it the version number and dash prefix, leaving the log entry
   `entryHash` value.
2. Determine the hash algorithm used by the [[ref: DID Controller]] from the [[ref: multihash]] `entryHash` value.
   - The hash algorithm **MUST** be one listed in the
   [parameters](#didwebvh-did-method-parameters) defined by the version of the
   `did:webvh` specification being used by the [[ref: DID Controller]] based on the
   `method` [[ref: parameters]] property set in the current or most recent prior [[ref: log entry]].
3. Remove the [[ref: Data Integrity]] `proof` from the [[ref: log entry]].
4. Set the `versionId` in the entry object to be the `versionId` from the
   previous [[ref: log entry]]. If this is the first entry in the log, set the value to
   `<scid>`, the value of the [[ref: SCID]] of the DID.
5. Calculate the hash string as `base58btc(multihash(JCS(entry), <hash algorithm>))`, where:
   1. `entry` is the data from the previous step.
   2. `JCS` is an implementation of the [[ref: JSON Canonicalization Scheme]]
      ([[spec:rfc8785]]). Its output is a canonicalized representation of its
      input.
   3. `multihash` is an implementation of the [[ref: multihash]] specification.
      Its output is a hash of the input using the associated `<hash algorithm>`,
      prefixed with a hash algorithm identifier and the hash size.
   4. `<hash algorithm>` is the hash algorithm from Step 2.
   5. `base58btc` is an implementation of the [[ref: base58btc]] function.
      Its output is the base58 encoded string of its input.
6. Verify that the calculated value matches the extracted `entryHash` value from
   Step 1. If not, terminate the resolution process with an error.

#### Authorized Keys

Each entry in the [[ref: DID Log]] **MUST** include a [[ref: Data Integrity]]
`proof` property signed by a key **authorized** to control (create, update, deactivate) the
DID. The authorized verification keys for `did:webvh` are the [[ref: multikey]]-formatted
public keys in the **active** `updateKeys` list from the `parameters` property of
the [[ref: log entries]]. Any of the authorized verification keys may be referenced
in the [[ref: Data Integrity]] proof.

For the first [[ref: log entry]] the **active** `updateKeys` list is the one in
that first [[ref: log entry]]. 

A resolver of the DID **MUST** verify the signature and the key used for signing
each [[ref: DID Log]] entry **MUST** be one from the list of active
`updateKeys`. If not, terminate the resolution process with an error.

The `did:webvh` Implementation Guide contains further discussion on the management
of keys authorized to update the DID.

The **active** `updateKeys` for subsequent [[ref: entries]] depends if the [[ref: Pre-Rotation]] is active or not.

##### No Key Prerotation

For all subsequent [[ref: entries]], the **active** list
is the most recent `updateKeys` **before** the [[ref: log entry]] to be verified. Thus,
the general case is that each [[ref: log entry]] is signed by the keys from the
**previous** [[ref: log entry]]. Once a [[ref: log entry]] containing an `updateKeys` list is
published, that `updateKeys` becomes the active list, and previous
`updateKeys` are ignored.

##### Prerotation

For all subsequent [[ref: entries]], the **active** list
is the `updateKeys` from the  **current** [[ref: log entry]] to be verified. Thus,
the general case is that each [[ref: log entry]] is signed by the keys from the
**current** [[ref: log entry]].

#### DID Portability

As noted in the [Update (rotate)](#update-rotate) section of the specification,
a `did:webvh` DID can be renamed by changing the `id` DID string in the
DIDDoc to one that resolves to a different HTTPS URL if the following conditions are met.

- The [[ref: DID Log]] of the renamed DID **MUST** contain all of the [[ref: log entries]]
  from the creation of the DID.
- The [[ref: log entry]] in which the DID is renamed **MUST** be a valid DID entry
  building on the prior [[ref: DID log entries]], per this specification.
- The [[ref: parameter]] `portable` **MUST** be set to `true`, as defined in the
  [DID Method Parameters](#didwebvh-did-method-parameters) section.
- The [[ref: SCID]] **MUST** be the same in the original and renamed DID.
- The [[ref: DIDDoc]] **MUST** contain the prior DID string as an `alsoKnownAs` entry.

#### Pre-Rotation Key Hash Generation and Verification

Pre-rotation requires a [[ref: DID Controller]] to commit to the authorization
keys that will be used ("rotated to") in the next [[ref: log entry]] for updating the [[ref: DIDDoc]]. The purpose
of committing to future keys is that if the currently authorized keys are
compromised by an attacker, the attacker should not be able to take control of
the DID by using the compromised keys to rotate to new keys the attacker
controls. Assuming the attacker has not also compromised the committed key
pairs, they cannot rotate the authorization keys without detection. See the
non-normative section about [Using [[ref: Pre-Rotation]] Keys]([#using-pre-rotation-keys](https://didwebvh.info/latest/implementers-guide/prerotation-keys/))
in the `did:webvh` Implementer's Guide for additional guidance.

As described in the [parameters](#didwebvh-did-method-parameters) section of
this specification, a [[ref: DID Controller]] **MAY** include the [[ref: parameter]]
`nextKeyHashes` with a non-empty list in any [[ref: DID log entry]] to activate
the [[ref: pre-rotation]] feature. When [[ref: pre-rotation]] is active, all
[[ref: multikey]] representations of the public keys in the `updateKeys` [[ref:
parameters]] property in other than the initial version of the [[ref: DID log
entry]] **MUST** have their hash in the  `nextKeyHashes` array from the previous
[[ref: DID log entry]]. If not, terminate the resolution process with an error.

A [[ref: DID Controller]] may turn off the use of pre-rotation by setting the
[[ref: parameter]] `nextKeyHashes` to `null` in any [[ref: DID log entry]]. If
there is an active set of `nextKeyHashes` at the time, the pre-rotation
requirements remains in effect for the [[ref: DID Log entry]]. The subsequent
[[ref: DID Log entry]] **MUST** use the non-pre-rotation rules.

To create a hash to be included in the `nextKeyHashes` array, the [[ref: DID
Controller]] **MUST** execute the following process for each possible future
authorization key.

1. Generate a new key pair. The key type **MUST** be one that can be used as a
   `did:webvh` authorization key.
2. Generate a [[ref: multikey]] representation of the public key of the new key
   pair.
3. Calculate the hash string as `base58btc(multihash(multikey))`, where:
   1. `multikey` is the [[ref: multikey]] representation of the public key from Step 2.
   2. `multihash` is an implementation of the [[ref: multihash]] specification.
      Its output is a hash of the input using the associated `<hash algorithm>`,
      prefixed with a hash algorithm identifier and the hash size.
   3. `<hash algorithm>` is the hash algorithm used by the [[ref: DID Controller]].
      The hash algorithm **MUST** be one listed in the
      [parameters](#didwebvh-did-method-parameters) defined by the version of the
      `did:webvh` specification being used by the [[ref: DID Controller]].
   4. `base58btc` is an implementation of the [[ref: base58btc]] function.
      Its output is the base58 encoded string of its input.
4. Insert the calculated hash into the `nextKeyHashes` array being built up within
   the [[ref: parameters]] property.
5. The generated key pair **SHOULD** be safely stored so that it can be used in
   the next [[ref: log entry]] to become a DID authorization key. At that time, the
   [[ref: multikey]] representation of the public key will be inserted into the
   `updateKeys` property in the [[ref: parameters]] and the private key can be used to sign the [[ref: log entry]]'s DID update authorizations
   proofs.

A [[ref: DID Controller]] **MAY** add include extra entries (for keys or just random
strings) in a `nextKeyHashes` array.

When processing other than the first [[ref: DID log entry]] where
[[ref: pre-rotation]] feature is active, a `did:webvh` resolver **MUST**:

1. For each [[ref: multikey]] in the `updateKeys` property in the `parameters` of
   the [[ref: log entry]], calculate the hash and hash algorithm for the [[ref: multihash]]
   [[ref: multikey]].
2. The hash algorithm **MUST** be one listed in the
   [parameters](#didwebvh-did-method-parameters) defined by the version of the
   `did:webvh` specification being used by the [[ref: DID Controller]].
3. The resultant hash **MUST** be in the `nextKeyHashes` array from the previous [[ref: log entry]] prior to
   being processed. If not, terminate the resolution
   process with an error.
4. A new `nextKeyHashes` list **MUST** be in the `parameters` of the [[ref: log entry]]
   currently being processed. If not, terminate the resolution process with an error.

#### DID Witnesses

The [[ref: witness]] process for a `did:webvh` DID provides a way for
collaborators to work with the [[ref: DID Controller]] to "witness" the
publication of new versions of the DID. This specification defines the technical
mechanism for using [[ref: witnesses]]. Governance and policy questions about
when and how to use the technical mechanism are outside the scope of this
specification.

Witnesses can prevent a [[ref: DID Controller]] from updating/removing
versions of a DID without detection by the witnesses. [[ref: Witnesses]] are
also a further mitigation against malicious actors compromising both a [[ref:
DID Controller]]'s authorization key(s) to update the DID, and the [[ref: DID
Controller]]'s web site where the [[ref: DID log]] is published. With both
compromises, a malicious actor might be able to take control over the DID by rewriting the
[[ref: DID Log]] using the keys they have compromised. By adding [[ref:
witnesses]] to monitor and approve each version update, a malicious actor cannot
rewrite the previous history without having compromised a sufficient number of
[[ref: witnesses]], the [[ref: DID Controller]]'s key(s), and the Web Server on
which the [[ref: DID Log]] is published.

##### Witness Lists

The list of DIDs that witness DID updates are defined in the `witness`
parameter, as described in the [Parameters](#didwebvh-did-method-parameters)
section of this specification. After the first `witness` parameter has been
added to a [[ref: DID log entry]], and while there are active witnesses, a
[[ref: threshold]] of the active witnesses must provide valid proofs associated
with each [[ref: DID log entry]] before the [[ref: DID log entry]] can be
published. If a [[ref: DID log entry]] contains a new (replacement) list of
witnesses (by including a new `witness` [[ref: parameter]]) that new list
becomes active **AFTER** the new [[ref: DID log entry]] has been published. Such
a replacement **MAY** be a `null`. Once a [[ref: witness]] set to `null` becomes
active, updates to the DID are not [[ref: witnessed]].

##### Witness DIDs and Reputation

`did:webvh` witness DIDs **MUST** be `did:key` DIDs.

If there is a need in an ecosystem to identify who the witnesses are, a
mechanism should be defined by the governance of the ecosystem, such as the
entry of the DID in a trust registry. Such mechanisms are outside the
scope of this specification.

##### The `witness` Parameter

The `witness` element in a [[ref: parameters]] object of a [[ref: DID Log entry]]
has the following data structure:

```json

"witness" : {
  "threshold": n,
  "witnesses" : [
      {
         "id": "<did:key DID of witness>",
         "weight": n
      }
   ]
}

```

where:

- threshold: an integer that must be attained or surpassed by the sum of the witnesses weights for a DID log entry to be considered approved.
- witnesses: an array of witnesses, each including the required fields:
  - id: the DID of the witness. The DID **MUST** be a `did:key` DID.
  - weight: an integer that is the weight given to this witness's approval

##### Witness Threshold Algorithm

The use of the [[ref: threshold]] and weighted approvals (versus needing
approvals from all [[ref: witnesses]]) is to prevent faulty [[ref: witnesses]]
from blocking the publishing of a new version of the DID. To determine if the
[[ref: threshold]] has been met, all participants **MUST** sum the `weight`
integer of the received approvals. and if it is equal to or more than the
`threshold` **MUST** be accepted as "[[ref: witnessed]]".

For example, if there are three [[ref: witnesses]] with a `weight` of `1`, a
fourth with a weight of `2`, and a `threshold` of `3`, the [[ref: threshold]] is met
by either the fourth plus any one of the other [[ref: witnesses]] (`2+1`), or
all of the first three witness (`1+1+1`) providing an approving `proof`.

##### The Witness Proofs File

Proofs from [[ref: witnesses]] are placed into a separate file
(`did-witness.json`) from the [[ref: DID Log]]. The same [DID to HTTPS
Transformation](#the-did-to-https-transformation) used for the [[ref: DID Log]]
is used to locate the `did-witness.json` resource, with only the last element
changed (`did.jsonl` to `did-witness.json`). The media type of the file
**SHOULD** be `application/json`.

The data model for the `did-witness.json` file is:

```json
[
  {
    "versionId": "1-Qmba111111...",
    "proof": [{ ... }, { ... }]
  },
  {
    "versionId": "2-Qzmb222222...",
    "proof": [{ ... }, { ... }]
  }
]
```

Where:

- `versionId` is the `versionId` of the [[ref: DID log entry]] to which the
  [[ref: witness]] proofs apply.
- `proof` is an array of [[ref: Data Integrity]] proofs that use the `versionId`
  as input data.  The permitted [[ref: Data Integrity]] cryptosuites used by the
  [[ref: witnesses]] **MUST** be `eddsa-jcs-2022` as referenced in [spec:di-eddsa-v1.0].

A valid proof from a [[ref: witness]] carries the implication that all prior
[[ref: DID Log entries]] are also approved by that witness. To maintain a
manageable `did-witness.json` file size, the [[ref: DID Controller]] **SHOULD**
remove all older proofs for **published** [[ref: DID Log entries]], keeping only the
latest proof for each witness.

To eliminate the race condition in publishing the [[ref: DID Log]] and
`did-witness.json` files, when a new [[ref: DID Log entry]] is being added,
[[ref: witness]] proofs **MUST** be added to the `did-witness.json` file and
that file published **BEFORE** publishing the [[ref: DID Log]] file containing
the new [[ref: DID Log entry]]. As a result, `did:webvh` resolvers may find
proofs for unpublished [[ref: DID log entries]] in the `did-witness.json` file.
Resolvers **MUST** ignore proofs with `versionId`s not in the [[ref: DID Log]]
file. Since resolvers cannot verify an unpublished [[ref: DID log entry]], the
[[ref: witness]] proofs on unpublished [[ref: DID log entries]] do not carry the
implication of approval of prior [[ref: DID Log entries]]. Therefore, at times
there may be two proofs in the `did-witness.json` file for a [[ref: witness]]:

- The most recent proof for a published [[ref: DID Log entry]].
- An additional proof that applies to an unpublished [[ref: DID Log entry]].

To ensure file cleanliness and avoid unnecessary clutter any `did-witness.json`
array entry without proofs (containing only the `versionId`) **SHOULD** be
removed.

##### Witnessing a DID Version Update

The following process is used to witness a DID version update:

- The [[ref: DID Controller]] prepares the full [[ref: DID Log Entry]] (including the
  `proof` element) for the new version of the DID, and shares it with the active [[ref: witnesses]].
  - The specification leaves to implementers *how* the [[ref: log entry]] data is provided to the [[ref: witnesses]].
- The [[ref: witnesses]] ***MUST** hold their own copy of the published [[ref:
  DID Log]] prior to witnessing a [[ref: DID Log entry]].
- Each [[ref: witness]] verifies the [[ref: DID Log Entry]], as defined by this
  specification. If not verified, the [[ref: witnesses]] **MUST NOT** approve the [[ref: log entry]].
- Each [[ref: witness]] determines (based on the governance of the ecosystem)
  if they approve of the DID version update.
  - The meaning of "approve" for any given implementation is outside the scope of this specification.
- If the verification is successful and approval granted, the [[ref: witness]]
  creates and sends to the [[ref: DID Controller]] a [[ref: Data Integrity]]
  proof signed using the [[ref: witness]]'s `did:key` DID.
  - The specification leaves to implementers how [[ref: witness]] proofs are
    conveyed to the [[ref: DID Controller]].
- The [[ref: DID Controller]] **MUST** create or add the proof to the record for
  the applicable `versionId` for the unpublished [[ref: DID log entry]].
  to the `did-witness.json` file.
  - The [[ref: DID Controller]] **MAY** publish the updated `did-witness.json` file
    as new witness proofs are added to the file.
  - The [[ref: DID Controller]] **MUST** publish the updated `did-witness.json` file
    **after** a [[ref: threshold]] of witness proofs have been received and **before** the
    witnessed [[ref: DID Log]] file is published.

##### Verifying Witness Proofs During Resolution

A `did:webvh` resolver **MUST** verify that all [[ref: DID Log entries]] that
have active [[ref: witnesses]] have a [[ref: threshold]] of active witnesses
approving the [[ref: log entry]]. To do so, resolvers must:

- Successfully complete the non-[[ref: witness]] verifications of the [[ref: DID Log]].
- Verify the [[ref: witness]] proofs in the `did-witness.json` file.
  - The resolver **MUST** ignore the proofs of any unpublished [[ref: DID Log entries]].
  - If any of the proofs of published [[ref: DID Log entries]] do not validate,
  terminate the resolution process with an error.
- For each [[ref: DID log entry]] requiring witnessing, the resolver **MUST**
  confirm that the `did-witness.json` file contains verified [[ref: witness]]
  [[ref: Data Integrity]] proofs from a [[ref: threshold]] of the then active
  [[ref: witnesses]] for the current or any **later** published log entries. If
  not, terminate the resolution process with an error.

If you want to learn more about the practical application of witnesses, see the
Implementer's Guide section on
[Witnesses](https://didwebvh.info/latest/implementers_guide/#witnesses) on the
`did:webvh` information site for more discussion on the witness capability and
using it in production scenarios.

#### Publishing a Parallel `did:web` DID

Each time a `did:webvh` version is created, the [[ref: DID Controller]] **MAY**
generate a corresponding `did:web` to publish along with the `did:webvh`. To do
so, the [[ref: DID Controller]] **MUST**:

1. Start with the resolved version of the [[ref: DIDDoc]] from `did:webvh`.
2. Execute a text replacement across the [[ref: DIDDoc]] of `did:webvh:<SCID>:` to
   `did:web:`, where `<scid>` is the actual `did:webvh` [[ref: SCID]].
3. Add to the [[ref: DIDDoc]] `alsoKnownAs` array, the full `did:webvh` DID. If the
   `alsoKnownAs` array does not exist in the [[ref: DIDDoc]], it **MUST** be added.
4. Publish the resulting [[ref: DIDDoc]] as the file `did.json` at the web location
   determined by the specified `did:web` DID-to-HTTPS transformation.

The benefit of doing this is that resolvers that have not been updated to
support `did:webvh` can continue to resolve the [[ref: DID Controller]]'s DIDs.
`did:web` resolvers that are aware of `did:webvh` features can use that knowledge,
and the existence of the `alsoKnownAs` `did:webvh` data in the [[ref: DIDDoc]] to get the
verifiable history of the DID.

The risk of publishing the `did:web` in parallel with the `did:webvh` is that the
added security and convenience of using `did:webvh` are lost.

### DID URL Resolution
The `did:webvh` DID Method embraces the power and usefulness of DID URLs, along
with the semantic simplicity of using them with a web-based DID method.
Specifically, a `did:webvh` implementation **MUST**:

- Resolve the `/whois` DID URL path using a [[spec:LINKED-VP]] service, whether
  or not it exists in the `did:webvh` [[ref: DIDDoc]], returning a [[ref:
  Verifiable Presentation]], if published by the [[ref: DID Controller]], found
  at the same path as the `did.jsonl` file (excluding the `.well-known` folder,
  if present), using the `/whois.vp` filename component, and the
  `application/vp' media type, as per the [IANA Verifiable Presentation
  Assignment](https://www.iana.org/assignments/media-types/application/vp).
  - For example, `did:webvh:{SCID}:example.com/whois` returns the
    [[ref: verifiable presentation]] from `https://example.com/whois.vp`.
- Resolve any `did:webvh` DID URL using a [[spec:DID-CORE]] `relativeRef` DID
  [[ref: parameter]], whether or not a supporting service exists in the `did:webvh` [[ref: DIDDoc]],
  returning the file found at web location corresponding to the DID-to-HTTPS
  transformation (excluding the `.well-known` folder, if present).
  - For example, resolving `did:{SCID}:webvh:example.com/governance/issuers.json` returns
    the file `https://example.com/governance/issuer.json`

In both cases, a [[ref: DID Controller]] **MAY** define services in the DIDDoc
that override the default services that **MUST** be resolved by the `did:webvh`
DID Method.

The sections below formalize the services that exist by default in `did:webvh` and
how a [[ref: DID Controller]] can override them.

#### whois LinkedVP Service

The `#whois` service enables those that receive a `did:webvh` DID to retrieve and
a [[ref: Verifiable Presentation]] (and embedded [[ref: Verifiable Credentials]])
the [[ref: DID Controller]] has decided to publish about itself. The intention
is that anyone wanting to learn more about a particular `did:webvh`
DID can resolve the `<did>/whois` DID URL to retrieve a [[ref: Verifiable Presentation]]
published by the [[ref: DID Controller]] that contains [[ref: Verifiable Credentials]]
with the DID as the subject. The DID Controller includes in the [[ref: Verifiable Presentation]]
any [[ref: Verifiable Credentials]] that it thinks might be helpful for resolvers
in making a trust decision about the [[ref: DID Controller]].

It is up to the [[ref: DID Controller]] to decide to publish a `whois`
[[ref: verifiable presentation]], and which [[ref: verifiable credentials]] to put into the
[[ref: verifiable presentation]]. It is up to a DID resolver to decide what attestations
from third parties are useful in making a trust decision about the [[ref: DID Controller]].

`did:webvh` DIDs **automatically** supports a `/whois` service endpoint with the
following definition based on the [[spec:LINKED-VP]] specification, with the
`serviceEndpoint` defining a similar `did:webvh` DID-to-HTTPS DID Log
transformation with `did.jsonl` changed to `whois.vp`. Differing from the
[DID-to-HTTPS transformation](#the-did-to-https-transformation) is that the
`.well-known/` component of the `did.jsonl` transformation is dropped from the
`whois.vp` resolution.

```json
{
   "@context": "https://identity.foundation/linked-vp/contexts/v1",
   "id": "#whois",
   "type": "LinkedVerifiablePresentation",
   "serviceEndpoint": "<did-to-https-translation>/whois.vp"
}
```

The returned `whois.vp` **MUST** contain a [[ref: W3C VCDM]] [[ref: verifiable presentation]]
signed by the DID and containing [[ref: verifiable credentials]]
that **MUST** have the DID as the `credentialSubject`.

A [[ref: DID Controller]] **MAY** explicitly add to their [[ref: DIDDoc]] a `did:webvh`
service with the `"id": "#whois"`. Such an entry **MUST** override the implicit
`service` above. If the [[ref: DID Controller]] wants to publish the `whois`
[[ref: verifiable presentation]] in a different format than the [[ref: W3C VCDM]]
format, they **MUST** explicitly add to their [[ref: DIDDoc]] a service with the
`"id": "#whois"` to specify the name and implied format of the [[ref: verifiable presentation]].

To resolve the DID URL `<did:webvh DID>/whois`, the resolver **MUST**:

1. Resolve the given `did:webvh` DID by retrieving, processing, and verifying the
   [[ref: DID log]] for the `did:webvh` as defined in this specification.
2. Find the [[ref: DIDDoc]] `service` with the `id` `#whois`, if any, or use the implicit
   service (above).
3. Resolve the `serviceEndpoint` URL, if possible, and return the document
   found.
   1. If the `serviceEndpoint` URL can't be resolved by the resolver (such as if
      the URL protocol is not supported by the resolver), the error `Error XXX:
      YYY` **MUST** be returned.
   2. If the file at the defined `serviceEndpoint` is not found, `Error
      404: Not Found` **MUST** be returned.

#### DID URL Path Resolution Service

The automatic resolution of `did:webvh` DID URL paths follows the
[[spec:DID-CORE]] `relativeRef` specification, as follows:

- a DID path, such as example 2 in [section 3.2 DID URL
  Syntax](https://www.w3.org/TR/did-core/#example-2) gives the example:
  `did:example:123456/resume.pdf`
- In turn, that can be treated as the following, as shown in example 8 in the
  same section: `did:example:123456?service=files&relativeRef=/resume.pdf`
- The `#files` service defined below then defines the `serviceEndpoint` for the
  `relativeRef`.
  - For `did:webvh`, that service is implicitly defined, with the
    `serviceEndpoint` matching the `did:webvh` [DID-to-HTTPS
    transformation](#the-did-to-https-transformation) and `did.jsonl` replaced
    by the DID URL Path. If `.well-known/` is part of the HTTPS URL, it is
    removed from the URL before resolving the URL.

Thus, the implicit service for DID `did:webvh:example.com:dids:<scid>` is:

```json
{
   "id": "#files",
   "type": "relativeRef",
   "serviceEndpoint": "https://example.com/dids/<scid>"
}
```

A [[ref: DID Controller]] **MAY** explicitly add to their [[ref: DIDDoc]] a service with
the `"id": "#files"`. Such an entry **MUST** override the implicit `service`
defined above.

To resolve the DID URL `<did:webvh DID>/path/to/file`, the resolver **MUST**:

1. Resolve the given `did:webvh` DID by retrieving, processing, and verifying the
   [[ref: DID log]] for the `did:webvh` as defined in this specification.
2. Find the [[ref: DIDDoc]] `service` with the `id` `#files`, if any, or use the implicit
   service (above).
3. Resolve the `serviceEndpoint` URL with the DID URL Path appended, if
   possible, and return the document found at that location.
   1. If the `serviceEndpoint` URL can't be resolved by the resolver (such as if
      the URL protocol is not supported by the resolver), the error `Error XXX:
      YYY` **MUST** be returned.
   2. If the file at the path appended to the defined `serviceEndpoint` is not
      found, the error `Error 404: Not Found` **MUST** be returned.
