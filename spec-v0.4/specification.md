## did:tdw DID Method Specification

### Target System

The target system of the Trust DID Web (TDW) DID method is the host (or domain)
name when the domain specified by the DID is resolved through the Domain Name
System (DNS) and verified by processing a log of DID versions.

### Method Name

The namestring that identifies this DID method is: `tdw`. A DID that uses this
method MUST begin with the following prefix: `did:tdw`. Per the DID
specification, this string MUST be in lowercase. The remainder of the DID, after
the prefix, is the [method-specific identifier](#method-specific-identifier),
specified below.

### Method-Specific Identifier

The `did:tdw` method-specific identifier contains both the [[ref:
self-certifying identifier]] (SCID) for the DID, and a fully qualified domain
name (with an optional path) that is secured by a TLS/SSL certificate. Given the
DID, a [transformation to an HTTPS URL](#the-did-to-https-transformation) can be
performed such that the [[ref: DID Log]] for the `did:tdw` DID is retrieved (via
an `HTTP GET`) and processed to produce the [[ref: DIDDoc]] for the DID. As per
the Augmented Backus-Naur Form (ABNF) notation below, the [[ref: SCID]] **MUST**
be the first element of the method-specific identifier.
  
Formal rules describing valid domain name syntax are described in
[[spec:RFC1035]], [[spec:RFC1123]], and [[spec:RFC2181]]. Each `did:tdw` DID's
globally unique [[ref: SCID]] **MUST** be
[generated](#scid-generation-and-verification) during the creation of the DID
based on its initial content and placed into the DID identifier for publication
and use.

The domain name element of the method-specific identifier MUST match the name
found in the SSL/TLS certificate per [[spec:RFC6125]] and the its replacement
[[spec:RFC9525]], and it MUST NOT include IP addresses. A port MAY be included
and the colon MUST be percent encoded to prevent a conflict with paths.
Directories and subdirectories MAY optionally be included, delimited by colons
rather than slashes.

As specified in the following Augmented Backus-Naur Form (ABNF) notation
[[spec:rfc2234]] the [[ref: SCID]] **MUST** be present in the DID string. See
examples below. The `domain-segment` and `path-segment` elements refer to
[[spec:rfc3986]]'s ABNF for a Generic URL (page 49). Attempting to replicate
here the full ABNF of those elements from that RFC would inevitably be wrong.

```abnf
tdw-did = "did:tdw:" scid ":" domain-segment 1+( "." domain-segment ) [ percent-encoded-port ] *( ":" path-segment )
scid = 46(base58-alphabet) ; The characters in the base58-btc-alphabet are as defined in the referenced W3C "Controller Documents" specification 
domain-segment = ; A part of a domain name as defined in RFC3986, such as "example" and "com" in "example.com"
percent-encoded-port = "%3A" ( "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9" ) 1*4( DIGIT )
path-segment= ; A part of a URL path as defined in RFC3986, such as "path", "to", "folder" in "path/to/folder"
```

The ABNF for a `did:tdw` is almost identical to that of `did:web`, with changes
only to the DID Method (`tdw` instead of `web`), and the addition of the
`<scid>:` (defined in the [SCID](#scid-generation-and-verification)) section of
this specification) element in `did:tdw` that is not in `did:web`. As specified
in the [DID-to-HTTPS Transformation](#the-did-to-https-transformation) section
of this specification, `did:tdw` and `did:web` DIDs that have the same fully
qualified domain and path transform to the same HTTPS URL, with the exception of
the final file -- `did.json` for `did:web` and `did.jsonl` for `did:tdw`.

### The DID to HTTPS Transformation

The `did:tdw` [method-specific identifier](#method-specific-identifier) is
defined to enable a transformation of the DID to an HTTPS URL for publishing
and retrieving the [[ref: DID Log]]. This section defines the transformation
from DID to HTTPS URL, including a number of examples.

Given a `did:tdw`, the HTTPS URL for the [[ref: DID Log]] is generated by
carrying out the following steps. The steps are carried out by the [[ref: DID
Controller]] to determine where to publish the [[ref: DID Log]], and by all resolvers to
retrieve the [[ref: DID Log]].

1. Remove the literal `did:tdw:` prefix from the DID, leaving the method specific
   identifier.
2. Remove the [[ref: SCID]] by removing the text up to and including the first colon
   (`<scid>:`) from the method-specific identifier and continue processing.
3. Replace `:` with `/` in the method-specific identifier to obtain the fully
   qualified domain name and optional path.
4. If there is no optional path, append `/.well-known` to the URL.
   1. When this algorithm is used for resolving a DID path (such as
      `<did>/whois` or `<did>/path/to/file as defined in the section [DID URL
      Handling](#did-url-resolution)), the `/.well-known` **MUST NOT** be
      included in the HTTPS URL.
5. If the domain contains a port, percent decode the colon.
6. Generate an HTTPS URL to the expected location of the [[ref: DIDDoc]] by prepending
   `https://`.
7. Append `/did.jsonl` to complete the URL.
   1. When this algorithm is used for resolving a DID path (such as
      `<did>/whois` or `<did>/path/to/file as defined in the section [DID URL
      Handling](#did-url-resolution)), append the DID URL path instead.

The following are some examples of various DID-to-HTTPS transformations based
on the processing steps specified above.

::: example

`did:tdw` DIDs and the corresponding web locations of their `did:tdw` log file.
In the examples,`{SCID}` is a placeholder for where the generated [[ref: SCID]] would be
placed in the actual DIDs and HTTPS URLs. Note that when the `{SCID}` follows
the literal `did:tdw:` as a separate element, the `{SCID}` is not part of the
HTTPS URL.

---

domain/`did:web`-compatible

`did:tdw:{SCID}:example.com` -->

`https://example.com/.well-known/did.jsonl`

subdomain

`did:tdw:{SCID}:issuer.example.com` -->

`https://issuer.example.com/.well-known/did.jsonl`

path

`did:tdw:{SCID}:example.com:dids:issuer` -->

`https://example.com/dids/issuer/did.jsonl`

path w/ port

`did:tdw:{SCID}:example.com%3A3000:dids:issuer` -->

`https://example.com:3000/dids/issuer/did.jsonl`

:::

The location of the `did:tdw` `did.jsonl` [[ref:DID Log]] file is the same as
where the comparable `did:web`'s `did.json` file is published. A [[ref: DID
Controller]] **MAY** choose to publish both DIDs and so, both files. The process
to do so is described in the [publishing a parallel `did:web`
DID](#publishing-a-parallel-didweb-did) section of this specification.

### The DID Log File

The [[ref: DID log]] file contains a list of [[ref: entries]], one for each version of the DID. A
version of the DID is an update to the contents of the resolved [[ref: DIDDoc]] for the
DID, and/or a change to the [[ref: parameters]] that control the generation and
verification of the DID.

Each entry is a JSON object consisting of the following properties.

`{ "versionId": "", "versionTime": "", "parameters": {}, "state": {}, "proof" : [] }`

1. The value of `versionId` **MUST** be a string consisting of the DID version number
   (starting at `1` and incrementing by one per DID version), a literal dash
   `-`, and the `entryHash`, a hash calculated across the [[ref: log entry]]
   content. The input to the hash is chosen so as to link each entry to its
   predecessor in a ledger-like chain. The input to the hash is specified in the
   [Entry Hash Generation and
   Verification](#entry-hash-generation-and-verification) section of this
   specification.
2. The value of `versionTime` **MUST** be a timestamp in UTC of the entry in [[ref:
   ISO8601]] format, as asserted by the [[ref: DID Controller]]. The timestamp
   **MUST** be the time the DID will be retrieved by a [[ref: witness]] or resolver,
   or before.
3. The JSON object `parameters` contains the configurations/options set by the
   [[ref: DID Controller]] to be used in the processing of current and future
   [[ref: log entries]]. Permitted `parameters` are defined in the [`did:tdw`
   DID Method Parameters](#didtdw-did-method-parameters) section of this
   specification.
4. The JSON object `state` contains the [[ref: DIDDoc]] for this version of the
   DID.
5. The JSON array `proof` contains a [[ref: Data Integrity]] proof calculated across
   the entry and signed by key authorized to update the [[ref: DIDDoc]].

After creation, each entry has (per the [[ref JSON Lines]] specification) all
extra whitespace removed, a `\n` character appended, and the result added to
the [[ref: DID Log]] file for publication.

A more comprehensive description of how to create and update a [[ref: DID log
entry]] is given in steps 4 - 6 of the [create DID](#create-register) section.

Examples of [[ref: DID Logs]] and [[ref: DID log entries]] can be found in the
[did:tdw` Examples](#didtdw-example) section of this specification.

### DID Method Operations

#### Create (Register)

Creating a `did:tdw` DID is done by carrying out the following steps.

1. **Define the DID string**
   The start of the DID **MUST** be the literal string "`did:tdw:{SCID}:`", where the `{SCID}` is
   a placeholder that will be replaced by the calculated [[ref: SCID]] later in the process (see step
   5). This first part of the DID string is followed by a fully qualified domain name
   (with an optional path) that is secured by a TLS/SSL certificate and
   reflects the web location at which the [[ref: DID Log]] (`did.jsonl`) will be published

   The DID **MUST** be a valid `did:tdw` DID as per the ABNF of a `did:tdw` DID defined
   in the [Method-Specific  Identifier](#method-specific-identifier) section of this specification.

   1. Note: the [[ref: SCID]] for a `did:tdw` DID is not by default in the HTTPS
      URL for the DID. A [[ref: DID Controller]] **MAY** include the [[ref:
      SCID]] in the HTTPS URL by inserting additional placeholder `{SCID}`
      strings into the domain name or path components of the method-specific
      identifier when creating the DID. Additional instance(s) of the [[ref:
      SCID]] in the domain and/or path parts of the DID does not alter the
      [DID-to-HTTPS transformation](#the-did-to-https-transformation).

2. **Generate the authorization key pair(s)**
   [Authorized keys](#authorized-keys) are authorized to control (create, update, deactivate) the DID.
   This includes generating any other key pairs that will be placed into the initial
   [[ref: DIDDoc]] for the DID.

   1. If the DID is to use [[ref: pre-rotation]], additional key generation will
      be necessary to generate the required "next" authorization keys and their
      corresponding [[ref: pre-rotation]] hashes.
   2. For each authorization key pair, generate a [[ref: multikey]] based on the
      key pair's public key. The [[ref: multikey]] representations of the public
      keys are placed in the `updateKeys` property in [[ref: parameters]].
   3. The public key(s) of the authorization key pair(s) **MAY** be used in the
      [[ref: DIDDoc]] as well, but that is not required.

3. **Create the initial [[ref: DIDDoc]] for the DID**
   The [[ref: DIDDoc]] **MUST** contain the top level `id` property which **MUST** be the DID string from
   step 1, including the placement of the `{SICD}` placeholder for the [[ref: SCID]]. Other
   [[ref: DIDDoc]] verifications **SHOULD** be performed.

   All other absolute reference's to the DID in the [[ref: DIDDoc]] must use the form defined
   in step 1, with the identified placeholder for the [[ref: SCID]] (e.g., `did:tdw:{SCID}:example.com#key-1`,
   `did:tdw:{SCID}:example.com:dids:issuer#key-1`, etc.).

   The [[ref: DIDDoc]] can contain any other content as deemed necessary by the [[ref: DID Controller]].

   1. Note: The placeholder (the string `{SCID}`) **MUST** be in every place in the [[ref: DIDDoc]] where
   the [[ref: SCID]] is to be placed.

4. **Generate a preliminary DID Log Entry** JSON object containing the same JSON
   properties that will be in the published [[ref: DID log entry]], but with some
   values preset, pending calculation of the [[ref: SCID]] and [[ref entryHash]] and
   without the `proof`.

   1. The value of `versionId` string **MUST** be the placeholder literal `"{SCID}"`.
   2. The value of `versionTime` string **MUST** be a valid UTC [[ref: ISO8601]] date/time string,
   and the represented time **MUST** be before or equal to the current time.
   3. The value of the `parameters` property **MUST** be a JSON object defined at the
      discretion of the [[ref: DID Controller]]. The properties in this nested JSON object
      **MUST** be as permitted in the [DID Generation and Verification
      Parameters](#didtdw-did-method-parameters) section of this specification,
      and all required values in the first version of the DID **MUST** be
      present. In addition, where the [[ref: SCID]] of the DID is referenced in
      the parameters, the placeholder literal string `{SCID}` **MUST** be used
      in place of the to-be-calculated [[ref: SCID]].
   4. The value of the `state` property **MUST** be the initial [[ref: DIDDoc]] as
      defined in the previous step 3 of this process.

5. **Update the preliminary DID Log Entry to the initial DID Log Entry**
   Use the preliminary [[ref: DID log entry]] to perform the consecutive steps:

   1. **Calculate the [[ref: SCID]]**
   The preliminary JSON object **MUST** be used to calculate the [[ref: SCID]] for the DID as defined in
   the [SCID Generation and Verification](#scid-generation-and-verification) section of this
   specification.
   2. **Replace the placeholder `{SCID}`** Replace throughout the preliminary
   JSON object the placeholder "`{SCID}`" with the calculated [[ref: SCID]] from
   the previous step.
   3. **Calculate the [[ref: Entry Hash]]**
   The preliminary JSON object updated in the previous step **MUST** be used to calculate the [[ref: Entry Hash]]
   (`entryHash`) for the [[ref: log entry]], as defined in the
   [Entry Hash Generation and Verification](#entry-hash-generation-and-verification) section of
   this specification.
   4. **Replace the preliminary `versionId` value** The value of the `versionId`
   property **MUST** be updated with the literal string `1` (for version number 1),
   a literal `-`, followed by the `entryHash` value calculated in the previous
   step.
   5. **Generate the [[ref: Data Integrity]] proof** A [[ref: Data Integrity]]
   proof on the preliminary JSON object as updated in the previous step **MUST**
   be generated using an authorized key in the required `updateKeys` property in the
   [[ref: parameters]] object.

   If the [[ref: DID Controller]] has opted to use [[ref: witnesses]] for the
   DID, the required approvals from the DID's [[ref: witnesses]] **MUST** be
   collected and added to the [[ref: Data Integrity]] proof property. See the [DID
   Witnesses](#did-witnesses) section of this specification.

   6. **Add the [[ref: Data Integrity]] proof** The [[ref Data Integrity]] proof
   is added to the preliminary JSON object. The resultant JSON object is the
   initial [[ref: DID log entry]] for the DID.

6. **Generate the first [[ref: JSON Line]]**
   The [[ref: DID log entry]] **MUST** be updated to be a [[ref: JSON Lines]]
   entry by removing extraneous white space and appending a carriage return,
   and the result stored as the contents of the file `did.jsonl`.

7. **Publish the [[ref: DID Log]]**
   The complete [[ref: DID Log]] file **MUST** be published at the appropriate Web location defined by
   the `did:tdw` DID identifier (see step 1)
     - This is a logical operation -- how a deployment serves the `did.jsonl`
       content is not constrained.
     - Use the [DID-to-HTTPS Transformation](#the-did-to-https-transformation)
       steps to transform the DID into the Web location of the [[ref: DID Log]]
       file.

A controller **MAY** generate an equivalent `did:web` [[ref: DIDDoc]] and publish it as
defined in the
[Publishing a Parallel `did:web` DID](#publishing-a-parallel-didweb-did) section
of this specification. The `did:web` [[ref: DIDDoc]] could be used for backwards
compatibility as a transition is made from `did:web` to `did:tdw`. Verifiers
using the `did:web` lose the verifiable properties and history of the `did:tdw`
for the convenience of the simple retrieval of the `did:web` [[ref: DIDDoc]].

#### Read (Resolve)

The following steps MUST be executed to resolve the [[ref: DIDDoc]] for a `did:tdw` DID:

1. The [DID-to-HTTPS Transformation](#the-did-to-https-transformation) steps
   **MUST** be used to transform the DID into an HTTPS URL for the [[ref: DID
   Log]] file.
2. Perform an HTTPS `GET` request to the URL using an agent that can successfully
   negotiate a secure HTTPS connection, which enforces the security requirements
   as described in
   [Security and privacy considerations](#security-and-privacy-considerations).
3. When performing the DNS resolution during the HTTPS GET request, the client
   SHOULD utilize [[spec:rfc8484]] in order to prevent tracking of the identity
   being resolved.
4. The [[ref: DID Log]] file **MUST** be processed as described below.

To process the retrieved [[ref: DID Log]] file, the resolver **MUST** carry out
the following steps on each of the [[ref: log entries]] in the order they appear in the
file, applying the [[ref: parameters]] set from the current and previous
entries. As noted in the [DID Log File](#the-did-log-file) section, [[ref: log entries]]
are each a JSON object with the following properties:

   1. `versionId`
   2. `versionTime`
   3. `parameters`
   4. `state` -- the version's [[ref: DIDDoc]].
   5. `proof` -- a [[ref: Data Integrity]] proof across the [[ref: log entry]].

For each entry:

1. Update the currently active [[ref: parameters]] with the [[ref: parameters]] from
   the entry (if any). Continue processing using the now active set of
   [[ref: parameters]].
   - While all [[ref: parameters]] in the first [[ref: Log Entry]] take effect
     immediately, some kinds of [[ref: parameters]] defined in later [[ref: entries]] only take
     effect *after* that entry has been published. For example, rotating the
     authorized keys to update a DID takes effect only *after* the entry in
     which they are defined has been published.
2. The [[ref: Data Integrity]] proof in the entry **MUST** be valid and signed by
   an authorized key as defined in the [Authorized Keys](#authorized-keys)
   section of this specification.
   1. If the [[ref: DID Controller]] has opted to use [[ref: witnesses]] and the
      last entry of the log is being processed, the [[ref: witness]] [[ref: Data
      Integrity]] proofs **MUST** be valid and **MUST** be signed by a threshold
      of [[ref: witnesses]]. For details, see the [DID
      Witnesses](#did-witnesses) section of this specification.
3. Verify the `versionId` for the entry. The `versionId` is the
   concatenation of the version number, a dash (`-`), and the `entryHash`.
   1. The version number **MUST** be `1` for the the first [[ref: log entry]] and **MUST** be
      incremented by one for each subsequent [[ref: log entry]].
   2. A dash `-` **MUST** follow the version number.
   3. The `entryHash` **MUST** follow the dash, and **MUST** be verified using
      the process defined in the [Entry Hash Generation and
      Verification](#entry-hash-generation-and-verification) section of this
      specification.
4. The `versionTime` **MUST** be a valid UTC [[ref: ISO8601]] date/time string. The
   `versionTime` for each [[ref: log entry]] **MUST** be greater than the
   previous entry's time. The `versionTime` of the last entry **MUST** be
   earlier than the current time.
5. Parse and apply the `did:tdw` DID Method configuration `parameters`. Note
   that in versions after the first, some `parameters` apply to immediately and
   impact the process of the current DID version, while others, such as
   `updateKeys` and `witnesses` apply after the current version has been
   published. The `parameters` **MUST** adhere to the [`did:tdw` DID Method
   Parameters](#didtdw-did-method-parameters) section of this specification.
6. When processing the first [[ref: DID log]] entry, verify the [[ref: SCID]]
   (defined in the [[ref: parameters]]) according to the
   [SCID Generation and Verification](#scid-generation-and-verification) section
   of this specification.
7. Get the value of the [[ref: log entry]] property `state`, which is the [[ref:
   DIDDoc]] for the version.
8. If [[ref: Key Pre-Rotation]] is being used, the hash of all `updateKeys` entries
   in the `parameters` property **MUST** match a hash in
   the active array of `nextKeyHashes` [[ref: parameter]], as defined in the
   [Key [[ref: Pre-Rotation]] Hash Generation and Verification](#pre-rotation-key-hash-generation-and-verification)
   section of this specification.
9. If any verifications fail, discard the DID as invalid with an error message.
10. As each [[ref: log entry]] is processed and verified, collect the following information
   about each version:
      1. The [[ref: DIDDoc]].
      2. The `versionId` of the [[ref: DIDDoc]].
      3. The UTC `versionTime`of the [[ref: DIDDoc]].
      4. The latest list of active [[ref: multikey]] formatted public keys
         authorized to update the DID, from the `updateKeys` lists in the
         [[ref: parameters]].
      5. If [[ref: pre-rotation]] is being used, the hashes of authorized DIDs that may
         be used in later `updateKeys` lists. The [[ref: pre-rotation]] hashes are in the
         `nextKeyHashes` list in the [[ref: parameters]].
      6. All other `did:tdw` processing configuration settings as defined by in the
         `parameters` object.

On completing the processing and successful verification of all [[ref: entries]] in the
[[ref: DID Log]], respond to the DID resolution request, including the
application of DID query [[ref: parameters]] such as `?versionId=` and `?versionTime=` with
the appropriate [[ref: DIDDoc]] version and content.

The following error codes and descriptions may be returned when resolving a DID.

:::todo

Document the full list of error codes that can be generated in resolving a DID.

:::

- Code 404: The `did:tdw` [[ref: DID Log]] file `did.jsonl` was not found.

##### Reading did:tdw DID URLs

A `did:tdw` resolver **MAY** implement the resolution of the `/whois` and a DID
URL Path using the [whois LinkedVP Service](#whois-linkedvp-service) and 
[DID URL Path Resolution Service](#did-url-path-resolution-service) as defined in
this specification by processing the [[ref: DID Log]] and then dereferencing the
DID URL based on the contents of the [[ref: DIDDoc]]. The client of a resolver that does
not implement those capabilities must use the resolver to resolve the
appropriate [[ref: DIDDoc]], and then process the resulting DID URLs themselves. Since
the default DID-to-HTTPS URL transformation is trivial, `did:tdw`
[[ref: DID Controllers]] are strongly encouraged to use the default behavior
for DID URL Path resolution.

#### Update (Rotate)

To update a DID, a new, verifiable [[ref: DID Log Entry]] must be generated,
witnessed (if necessary), appended to the existing [[ref: DID Log]] (`did.jsonl`),
and published to the web location defined by the DID. The process to generate a
verifiable [[ref: DID Log Entry]] follows a similar process to the
[Create](#create-register) process, as follows:

1. Make the desired changes to the [[ref: DIDDoc]]. While the contents of a new DIDDoc
   version are (mostly) up to the [[ref: DID controller]], there are some limitations:
   1. If the DID is configured to support [[ref: portability]], the root `id`
      property in the [[ref: DIDDoc]] **MAY** be changed when the [[ref: DID Controller]] wants to (or
      is forced to) publish the DID at a different Internet location and wants
      to retain the [[ref: SCID]] and history of the DID. For details, see the
      [DID Portability](#did-portability) section of this specification.
2. Define the [[ref: parameters]] JSON object to include the properties that affect the evolution of the
   DID. The `parameters` **MUST** be from those listed in the [`did:tdw` DID
   Method Parameters](#didtdw-did-method-parameters) section of this
   specification. Any [[ref: parameters]] defined in the JSON object override the
   previously active value, while any [[ref: parameters]] not included imply the
   existing values remain in effect. If no changes to the [[ref: parameters]]
   are needed, an empty JSON object `{}` **MUST** be used.
   - While all [[ref: parameters]] in the first [[ref: Log Entry]] take effect
     immediately, some types of [[ref: parameters]] defined in later [[ref: entries]] only take
     effect after the entry has been published. For example, rotating the keys
     authorized to update a DID or changing the [[ref: witnesses]] for a DID take effect
     only *after* the entry in which they are defined has been published.
3. Generate a preliminary [[ref: DID log entry]] JSON object containing the following properties:
   1. The value of `versionId` **MUST** be the value of `versionId` from the *previous* [[ref: DID log entry]].
   2. The `versionTime` value **MUST** be a string that is an [[ref: ISO8601]]
      format UTC timestamp. The time **MUST** be greater than the time of the
      previous [[ref: log entry]], and **MUST** be the time the DID will be
      retrieved by a [[ref: witness]] or resolver, or before.
   3. The [[ref: parameters]] passed in as a JSON object.
   4. Set the `state` JSON object to be the new version of the [[ref: DIDDoc]].
4. Calculate the new `versionId` of the new [[ref: DID Log Entry]], including
   incrementing the version number integer and using the process described in
   the [Entry Hash Generation and Verification](#entry-hash-generation-and-verification)
   section of this specification.
5. Replace the value of the `versionId` property in the preliminary [[ref: DID Log
   Entry]] with the value produced in the previous step.
6. Generate a [[ref: Data Integrity]] proof on the [[ref: DID log entry]] using
   an authorized key, as defined in the [Authorized Keys](#authorized-keys)
   section of this specification.
7. If the [[ref: DID Controller]] has opted to use [[ref: witnesses]] for the
   DID, collect the required approvals from the DID's [[ref: witnesses]], adding
   their proofs to the [[ref: data integrity]] proof. See the [DID
   Witnesses](#did-witnesses) section of this specification.
8. The proof JSON object **MUST** be added as the value of the `proof` property in the [[ref: log entry]].
9. The entry **MUST** be made a [[ref JSON Line]] by removing extra whitespace, adding a `\n`
   to the entry. 
10. The new [[ref: log entry]] **MUST** be appended to the existing contents of
    the [[ref: DID Log]] file `did.jsonl`.
11. The updated [[ref: DID Log]] file **MUST** be published the appropriate
    location defined by the `did:tdw` identifier.
    - This is a logical operation -- how a deployment serves the `did.jsonl`
    content is not constrained.

A controller **MAY** generate an equivalent, updated `did:web` [[ref: DIDDoc]] and
publish it as defined in the
[Publishing a Parallel `did:web` DID](#publishing-a-parallel-didweb-did)
section of this specification.

#### Deactivate (Revoke)

To deactivate the DID, the [[ref: DID Controller]] **MUST** add to the [[ref:
DID log entry]] [[ref: parameters]] the property name and value `"deactivated": true`. A [[ref: DID
Controller]] **SHOULD** update the [[ref: DIDDoc]] and `parameters` object to
further indicate the deactivation of the DID, such as including an empty
`updateKeys` list (`"updateKeys": []`) in the [[ref: parameters]], preventing
further versions of the DID.

A resolver encountering in the [[ref: DID log entry]] [[ref: parameters]] the
property key:value pair `"deactivated": true` **MUST** return in the [[ref: DIDDoc]] Metadata the property key:value 
`"deactivated": true`, as per the [[spec:DID-RESOLUTION]] specification.

### DID Method Processes

The [DID Method Operations](#did-method-operations) reference several processes
that are executed during [[ref: DIDDoc]] generation and DID resolution verification. Each
of those processes is specified in the following sections.

#### `did:tdw` DID Method Parameters

Entries in the `did:tdw` [[ref: DID Log]] contain the JSON object `parameters`
that define the DID processing [[ref: parameters]] being used by the [[ref: DID
Controller]] when publishing the current and subsequent [[ref: DID log
entries]]. A DID Resolver **MUST** use the same [[ref: parameters]] when
processing the [[ref: DID Log]] to resolve the DID. The `parameters` object
**MUST** only include properties defined in this specification.

::: example

An example of the JSON prettified `parameters` property in the first [[ref: DID Log]] entry for a DID:

``` json
{
    "prerotation": true,
    "portable": false,
    "updateKeys": [
      "z82LkqR25TU88tztBEiFydNf4fUPn8oWBANckcmuqgonz9TAbK9a7WGQ5dm7jyqyRMpaRAe"
    ],
    "nextKeyHashes": [
      "enkkrohe5ccxyc7zghic6qux5inyzthg2tqka4b57kvtorysc3aa"
    ],
    "method": "did:tdw:0.3",
    "scid": "{SCID}"
}
```

:::

The allowed [[ref: parameter]] properties and (where applicable) enumerated values for those
properties are defined below.

- `method`: Defines the `did:tdw` specification version to use when processing a
  given DID's log file. As new versions of this specifications are defined,
  additional [[ref: parameters]] and enumerated values will be associated with
  the `method` values. This allows a long lasting DID to evolve the settings
  being used by the DID over time, such as changing the hash algorithms
  permitted, or allowing other [[ref: Data Integrity]] cryptosuites.
  - This property **MUST** appear in the first [[ref: DID log entry]].
  - This property **MAY** appear in later [[ref: DID log entries]] to indicate that
    the processing rules for that and later [[ref: log entries]] have been changed to a
    different specification version.
  - Acceptable values for this specification are:
    - `did:tdw:0.4`: Requires that the rules defined in this version of the specification be used
      in processing the log. Implied by the value are the following:
      - The permitted hash algorithms used by the [[ref: DID Controller]] **MUST** be `SHA-256` as defined in [[spec: rfc6234]].
      - The permitted [[ref: Data Integrity]] cryptosuites used by the [[ref: DID Controller]] **MUST** be `eddsa-jcs-2022` as referenced in [[ref: eddsa-jcs-2022]].
- `scid`: The value of the [[ref: SCID]] for this DID.
  - This property **MUST** appear in the first [[ref: DID log entry]].
- `updateKeys`: An array of [[ref: multikey]] formatted public keys
  associated with the private keys that are authorized to sign the log entries
  that update the DID from one version to the next. An instance of the list in
  an entry replaces the previously active list. If an entry does not have the
  `updateKeys` property, the currently active list continues to apply. See the
  [Authorized Keys](#authorized-keys) section of this specification for
  additional details.
  - This property **MUST** appear in the first [[ref: DID log entry]] and **MAY**
    appear in subsequent entries, at the discretion of the
    [[ref: DID Controller]].
  - A key from the `updateKeys` array in the first [[ref: DID log entry]]
    **MUST** be used to authorize the initial [[ref: log entry]]. In all other
    [[ref: DID log entries]], an `updateKeys` property becomes active *after* the
    publication of its entry -- meaning its [[ref: log entry]] **MUST** be
    signed by a key the most recent `updateKeys` list from a **prior** [[ref:
    DID log]] entry.
- `portable`: A boolean (`true` / `false`) indicating if the DID is portable and
  thus can be renamed to change the Web location of the DID.
  - The value can **ONLY** be set to `true` in the first [[ref: log entry]], the initial version of the DID.
  - If not explicitly set in the first [[ref: log entry]], it is set to `false`.
  - Once the value has been set to `false`, it cannot be set back to `true`.
  - See the section of this specification on [DID Portability](#did-portability)
    for more details about renaming a `did:tdw` DID.
- `prerotation`: A boolean value indicating that subsequent authentication keys
  added to the [[ref: DIDDoc]] (after this version) **MUST** have their hash included in
  a `nextKeyHashes` [[ref: parameter]] property.
  - The value is initialized to `false` until the property is included in a
    [[ref: DID log entry]].
  - Once the value is set to `true` in a [[ref: DID log entry]] it **MUST NOT**
    be set to `false` in a subsequent entry.
- `nextKeyHashes`: An array of strings that are hashes of [[ref: multikey]]
  formatted public keys that **MAY** be added to the `updateKeys` list in the
  [[ref: log entry]] of a future version of the DID.
  - The process for generating the hashes and additional details for using [[ref: pre-rotation]] are defined in the
    [Pre-Rotation Key Hash Generation and Verification](#pre-rotation-key-hash-generation-and-verification)
    section of this specification.
  - If the [[ref: parameter]] `prerotation` has been set to `true`, all [[ref: multikey]]
    formatted public keys added in a new `updateKeys` list **MUST** have their
    hashes listed in the currently active `nextKeyHashes` list.
  - A [[ref: DID Controller]] **MAY** put extra strings in the `nextKeyHashes`
    array that are not subsequently used in an `updateKeys` entry.
  - When `prerotation` is active and the `updateKeys` [[ref: parameter]] is included in a
    `parameters` property, a `nextKeyHashes` property with a new set of hashes
    **MUST** be included in the same [[ref: parameters]] property. Any unused
    hashes in the prior `nextKeyHashes` are ignored.
- `witness`: A JSON object containing the [[ref: parameters]] for declaring the witnesses
  for the DID, and the [[ref: parameters]] for the process of updating a DID via a
  collaboration with [[ref: witnesses]] prior to publication. For details of
  this data and its usage in the approvals process, see the
  [DID Witnesses](#did-witnesses) section of this specification.
  - A `witness` property in the first [[ref: DID log entry]] is used to define the
    [[ref: witnesses]] and necessary threshold for that initial [[ref: log entry]]. In all other
    [[ref: DID log entries]], a `witness` property becomes active **after** the publication
    of its entry -- meaning its [[ref: log entry]] **MUST** be witnessed by the most recent
    `witnesses` from a **prior** [[ref: DID log]] entry.
- `deactivated`: A JSON boolean that **SHOULD** be set to `true` when the DID is to
  be deactivated. See the [deactivate (revoke)](#deactivate-revoke) section of
  this specification for more details.
- `ttl`: A number, the number of seconds that a cache entry for a resolved
  `did:tdw` DID **SHOULD** last, as recommended by the [[ref: DID Controller]]. A
  resolver can use this value in deciding whether to retrieve a new version of
  the DID's `did.jsonl` file. If not specified, resolvers **MAY** set a default
  based on the business needs of the resolver clients.
  - Caching a `did:tdw` can be valuable in places where the business rules
    require resolving a number of DID URLs for the same DID. For example, a
    client might want call the resolver to the current [[ref: DIDDoc]], and then make
    repeated calls to get all of the previous versions of the [[ref: DIDDoc]]. By caching
    the [[ref: DIDDoc]] state, the resolver would not have to retrieve and process the
    [[ref: DID Log]] on each call.
  - A Web Server handling one or more `did.jsonl` files **MAY** be configured to
   use a comparable HTTP TTL per [[spec-inform:rfc9111]].

#### SCID Generation and Verification

The [[ref: self-certifying identifier]] or `SCID` is a required [[ref: parameter]] in the
first [[ref: DID log entry]] and is the hash of the DID's inception event.

##### Generate SCID

To generate the [[ref: SCID]] for a `did:tdw` DID, the DID Controller
**MUST** execute the following function:

 `base58btc(multihash(JCS(preliminary log entry with placeholders), <hash algorithm>))`

Where:

1. The `preliminary [[ref: log entry]] with placeholders` consists of the following
   pre-publication JSON object of what will become the first [[ref: log entry]]. The
   placeholder is the literal string "`{SCID}`".

   - The `versionId` entry, which **MUST** be `{SCID}`.
   - The `versionTime` entry, which **MUST** be a string that is the current time in
         UTC [[ref: ISO8601]] format, e.g., `"2024-04-05T07:32:58Z"`
   - The complete `parameters` for the initial [[ref: log entry]] as defined by the
     [[ref: DID Controller]], with the placeholder wherever the [[ref: SCID]] will
     eventually be placed.
   - The `state` JSON object with the value being the initial [[ref: DIDDoc]]
     with placeholders (the literal string "`{SCID}`") wherever the [[ref:
     SCID]] will eventually be placed in the [[ref: DIDDoc]].

2. `JCS` is an implementation of the [[ref: JSON Canonicalization Scheme]]
   [[spec:rfc8785]]. It outputs a canonicalized representation of its JSON
   input.
3. `multihash` is an implementation of the [[ref: multihash]] specification. Its
   output is a hash of the input using the associated `<hash algorithm>`,
   prefixed with a hash algorithm identifier and the hash size.
4. `<hash algorithm>` is the hash algorithm used by the [[ref: DID Controller]].
   The hash algorithm **MUST** be one listed in the
   [parameters](#didtdw-did-method-parameters) defined by the version of the
   `did:tdw` specification being used by the [[ref: DID Controller]].
5. `base58btc` is an implementation of the [[ref: base58btc]] function.
   Its output is the base58 encoded string of its input.

##### Verify SCID

To verify the [[ref: SCID]] of a `did:tdw` DID being resolved, the resolver
**MUST** execute the following process:

1. Extract the first [[ref: DID log entry]] and use it for the rest of the steps
   in this process.
2. Extract the `scid` property value from the [[ref: parameters]] in the [[ref: DID log entry]].
3. Determine the hash algorithm used by the [[ref: DID Controller]] from the [[ref: multihash]] `scid` value.
   - The hash algorithm **MUST** be one listed in the
   [parameters](#didtdw-did-method-parameters) defined by the version of the
   `did:tdw` specification being used by the [[ref: DID Controller]] based on the
   `method` [[ref: parameters]] property.
4. Remove the [[ref: data integrity]] proof property from the [[ref: DID log entry]].
5. Replace the `versionId` property value with the literal `"{SCID}"`.
6. Treat the resulting [[ref: log entry]] as a string and do a text replacement of the `scid`
   value from Step 2 with the literal string `{SCID}`.
7. Use the result and the hash algorithm (from Step 3) as input to the function
   defined in the [Generate SCID](#generate-scid) section (above).
8. The output string **MUST** match the `scid` extracted
   in Step 2. If not, terminate the resolution process with an error.

#### Entry Hash Generation and Verification

The `entryHash` follows the version number and dash character `-` in the
`versionId` property in each DID log entry. Each `entryHash` is calculated
across its [[ref: log entry]], excluding the [[ref: Data Integrity]] proof. The
`versionId` used in the input to the hash is a predecessor value to the current
[[ref: log entry]], ensuring that the [[ref: entries]] are cryptographically "chained"
together in a microledger. For the first [[ref: log entry]], the predecessor
`versionId` is the SCID (itself a hash), while for all other entries it is the
`versionId` property from the previous log entry.

##### Generate Entry Hash

To generate the required hash for a `did:tdw` [[ref: log entry]], the [[ref: DID Controller]]
**MUST** execute the process `base58btc(multihash(JCS(entry), <hash algorithm>))` given a
preliminary [[ref: log entry]] as the string `entry`, where:

1. `JCS` is an implementation of the [[ref: JSON Canonicalization Scheme]]
   ([[spec:rfc8785]]). Its output is a canonicalized representation of its
   input.
2. `multihash` is an implementation of the [[ref: multihash]] specification. Its
   output is a hash of the input using the associated `<hash algorithm>`,
   prefixed with a hash algorithm identifier and the hash size.
3. `<hash algorithm>` is the hash algorithm used by the [[ref: DID Controller]].
   The hash algorithm **MUST** be one listed in the
   [parameters](#didtdw-did-method-parameters) defined by the version of the
   `did:tdw` specification being used by the [[ref: DID Controller]].
4. `base58btc` is an implementation of the [[ref: base58btc]] function.
   Its output is the base58 encoded string of its input.

The following is an example of a preliminary [[ref: log entry]] that is processed to
produce an [[ref: entry hash]]. As this is a first entry in a [[ref: DID Log]], the input
`versionId` is the [[ref: SCID]] of the DID.

```json
{"versionId": "QmfGEUAcMpzo25kF2Rhn8L5FAXysfGnkzjwdKoNPi615XQ", "versionTime": "2024-09-26T23:22:26Z", "parameters": {"prerotation": true, "updateKeys": ["z6MkhbNRN2Q9BaY9TvTc2K3izkhfVwgHiXL7VWZnTqxEvc3R"], "nextKeyHashes": ["QmXC3vvStVVzCBHRHGUsksGxn6BNmkdETXJGDBXwNSTL33"], "method": "did:tdw:0.4", "scid": "QmfGEUAcMpzo25kF2Rhn8L5FAXysfGnkzjwdKoNPi615XQ"}, "state": {"@context": ["https://www.w3.org/ns/did/v1"], "id": "did:tdw:QmfGEUAcMpzo25kF2Rhn8L5FAXysfGnkzjwdKoNPi615XQ:domain.example"}}
```

Resulting [[ref: entryHash]]: `QmQq6Kg4ZZ1p49znzxnWmes4LkkWgMWLrnrfPre8UD56bz`

##### Verify The Entry Hash

To verify the `entryHash` for a given  `did:tdw` [[ref: DID log entry]], a DID
Resolver **MUST** execute the following process:

1. Extract the `versionId` in the [[ref: DID log entry]], and
   remove from it the version number and dash prefix, leaving the log entry
   `entryHash` value.
2. Determine the hash algorithm used by the [[ref: DID Controller]] from the [[ref: multihash]] `entryHash` value.
   - The hash algorithm **MUST** be one listed in the
   [parameters](#didtdw-did-method-parameters) defined by the version of the
   `did:tdw` specification being used by the [[ref: DID Controller]] based on the
   `method` [[ref: parameters]] property set in the current or most recent prior [[ref: log entry]].
3. Remove the [[ref: Data Integrity]] `proof` from the [[ref: log entry]].
4. Set the `versionId` in the entry object to be the `versionId` from the
   previous [[ref: log entry]]. If this is the first entry in the log, set the value to
   `<scid>`, the value of the [[ref: SCID]] of the DID.
5. Calculate the hash string as `base58btc(multihash(JCS(entry), <hash algorithm>))`, where:
   1. `entry` is the data from the previous step.
   2. `JCS` is an implementation of the [[ref: JSON Canonicalization Scheme]]
      ([[spec:rfc8785]]). Its output is a canonicalized representation of its
      input.
   3. `multihash` is an implementation of the [[ref: multihash]] specification.
      Its output is a hash of the input using the associated `<hash algorithm>`,
      prefixed with a hash algorithm identifier and the hash size.
   4. `<hash algorithm>` is the hash algorithm from Step 2.
   5. `base58btc` is an implementation of the [[ref: base58btc]] function.
      Its output is the base58 encoded string of its input.
6. Verify that the calculated value matches the extracted `entryHash` value from
   Step 1. If not, terminate the resolution process with an error.

#### Authorized Keys

Each entry in the [[ref: DID Log]] **MUST** include a [[ref: Data Integrity]]
`proof` property signed by a key **authorized** to control (create, update, deactivate) the
DID. The authorized verification keys for `did:tdw` are the [[ref: multikey]]-formatted
public keys in the **active** `updateKeys` list from the `parameters` property of
the [[ref: log entries]]. Any of the authorized verification keys may be referenced
in the [[ref: Data Integrity]] proof.

For the first [[ref: log entry]] the **active** `updateKeys` list is the one in
that first [[ref: log entry]]. For all subsequent [[ref: entries]], the **active** list
is the most recent `updateKeys` **before** the [[ref: log entry]] to be verified. Thus,
the general case is that each [[ref: log entry]] is signed by the keys from the
**previous** [[ref: log entry]]. Once a [[ref: log entry]] containing an `updateKeys` list is
published, that `updateKeys` becomes the active list, and previous
`updateKeys` are ignored.

A resolver of the DID **MUST** verify the signature and the key used for signing
each [[ref: DID Log]] entry **MUST** be one from the list of active
`updateKeys`. If not, terminate the resolution process with an error.

The `did:tdw` Implementation Guide contains further discussion on the management
of keys authorized to update the DID.

#### DID Portability

As noted in the [Update (rotate)](#update-rotate) section of the specification,
a `did:tdw` DID can be renamed by changing the `id` DID string in the
DIDDoc to one that resolves to a different HTTPS URL if the following conditions are met.

- The [[ref: DID Log]] of the renamed DID **MUST** contain all of the [[ref: log
  entries]] from the creation of the DID.
- The [[ref: log entry]] in which the DID is renamed **MUST** be a valid DID entry
  building on the prior [[ref: DID log entries]], per this specification.
- The [[ref: parameter]] `portable` **MUST** be set to `true`, as defined in the
  [DID Method Parameters](#didtdw-did-method-parameters) section.
- The [[ref: SCID]] **MUST** be the same in the original and renamed DID.
- The [[ref: DIDDoc]] **MUST** contain the prior DID string as an `alsoKnownAs` entry.

#### Pre-Rotation Key Hash Generation and Verification

Pre-rotation requires a [[ref: DID Controller]] to commit to the authorization
keys that will later be used ("rotated to") for updating the [[ref: DIDDoc]]. The purpose
of committing to future keys is that if the currently authorized keys are
compromised by an attacker, the attacker should not be able to take control of
the DID by using the compromised keys to rotate to new keys the attacker
controls. Assuming the attacker has not also compromised the committed key
pairs, they cannot rotate the authorization keys without detection. See the
non-normative section about [Using [[ref: Pre-Rotation]] Keys](#using-pre-rotation-keys)
in the Implementer's Guide for additional guidance.

As described in the [parameters](#didtdw-did-method-parameters)
section of this specification, a [[ref: DID Controller]] **MAY** define that
`prerotation` is active for the DID (value `true`). When [[ref: pre-rotation]] is active,
all verification [[ref: multikeys]] in the `updateKeys` [[ref: parameters]] property in other
than the initial version of the [[ref: DIDDoc]] **MUST** have their hash in the currently
active nextKeyHashes` array from a previous [[ref: DID log entry]]. If
not, terminate the resolution process with an error.

To create a hash to be included in the `nextKeyHashes` array, the [[ref: DID
Controller]] **MUST** execute the following process for each possible future
authorization key.

1. Generate a new key pair.
2. Generate a [[ref: multikeys]] representation of the public key of the new key
   pair.
3. Calculate the hash string as `base58btc(multihash(multikey))`, where:
   1. `multikey` is the [[ref: multikey]] representation of the public key from Step 2.
   2. `multihash` is an implementation of the [[ref: multihash]] specification.
      Its output is a hash of the input using the associated `<hash algorithm>`,
      prefixed with a hash algorithm identifier and the hash size.
   3. `<hash algorithm>` is the hash algorithm used by the [[ref: DID Controller]].
      The hash algorithm **MUST** be one listed in the
      [parameters](#didtdw-did-method-parameters) defined by the version of the
      `did:tdw` specification being used by the [[ref: DID Controller]].
   4. `base58btc` is an implementation of the [[ref: base58btc]] function.
      Its output is the base58 encoded string of its input.
4. Insert the calculated hash into the `nextKeyHashes` array being built up within
   the [[ref: parameters]] property.
5. The generated key pair **SHOULD** be safely stored so that it can be used in
   a later DID version to become a DID authorization key. At that time, the
   [[ref: multikey]] representation of the public key will be inserted into the
   `updateKeys` property in the [[ref: parameters]]. After that [[ref: log entry]] is
   published, the private key can be used to sign DID update authorizations
   proofs.

A [[ref: DID Controller]] **MAY** add include extra entries (for keys or just random
strings) in a `nextKeyHashes` array.

When processing other than the first [[ref: DID log entry]] where the
`prerotation` [[ref: parameter]] is active, a `did:tdw` resolver **MUST**:

1. For each [[ref: multikey]] in the `updateKeys` property in the `parameters` of
   the [[ref: log entry]], calculate the hash and hash algorithm for the [[ref:
   mulithash]] [[ref: multikey]].
2. The hash algorithm **MUST** be one listed in the
   [parameters](#didtdw-did-method-parameters) defined by the version of the
   `did:tdw` specification being used by the [[ref: DID Controller]].
3. The resultant hash **MUST** be in the most recently set `nextKeyHashes` prior to
   the [[ref: log entry]] being processed. If not, terminate the resolution
   process with an error.
4. A new `nextKeyHashes` list **MUST** be in the `parameters` of the [[ref: log
   entry]] currently being processed. If not, terminate the resolution process with
   an error.

#### DID Witnesses

The [[ref: witness]] process for a DID provides a way for other collaborators to
work with the [[ref: DID Controller]] to "witness" the publication of a new version of
the DID. Including [[ref: witnesses]] can prevent malicious updates to the DID by both
the [[ref: DID Controller]] and external parties. This specification defines
the mechanism for using [[ref: witnesses]] but leaves the governance and policy
questions about when and how to use the mechanism to implementers.

Witnesses can prevent a [[ref: DID Controller]] from updating/removing DID versions of a
DID without detection. [[ref: Witnesses]] are also a further mitigation against malicious
actors compromising both a [[ref: DID Controller]]'s authorization key(s) to update the
DID, and the [[ref: DID Controller]]'s web site where the [[ref: DID log]] is published.
With both compromises, a malicious actor could take control over the DID by
rewriting the [[ref: DID Log]] using the keys they have comprised. By adding
[[ref: witnesses]] that monitor and approve each version update, a malicious
actor cannot rewrite the previous history without also compromising a sufficient
number of [[ref: witnesses]].

An overview of the [[ref: witness]] mechanism is as follows:

- The [[ref: DID Controller]] specifies (in the `parameters` of a [[ref: log
  entry]]) a list of [[ref: witnesses]], DIDs that together with the [[ref: DID
  Controller]] will contribute to "approving" all subsequent versions of the
  DID.
  - Ideally, the [[ref: DID Controller]] does that in the inception event for the
    DID.
  - Over time, the list of [[ref: witnesses]] may evolve, with each change being
    approved by the declared list of [[ref: witnesses]] from **before** such a
    change.
- The [[ref: DID Controller]] prepares a [[ref: DID Log Entry]] and shares it with
  the [[ref: witnesses]].
  - The specification leaves to implementers *how* the [[ref: log entry]] data is provided to the [[ref: witnesses]].
- Each [[ref: witness]] verifies the [[ref: DID Log Entry]], as defined by this
  specification. If not, the [[ref: witnesses]] **MUST NOT** approve the [[ref: log entry]].
  - The [[ref: witnesses]] ***MUST** have their own copy of the current [[ref:
    DID Log]].
- Each [[ref: witness]] determines (based on the governance of the ecosystem)
  if they approve of the DID version update.
  - This specification has no opinion on what "approve" means for any
    deployment of `did:tdw`. That is up to the ecosystem in which the [[ref: DID
    Controller]] and [[ref: witnesses]] are participating.
- If the verification is successful and the approval granted, the [[ref:
  witness]] sends a [[ref: Data Integrity]] proof across the [[ref: DID log entry]] to the [[ref: DID Controller]], similar
  to that generated by the [[ref: DID Controller]], but signed by the [[ref: witness]]'s key.
- When a weighted threshold of proofs are received, the DID Controller
  inserts the [[ref: witnesses]]'s proofs into the `proof` array in
  the [[ref: DID Log Entry]] and publishes the updated version of the [[ref: DID
  Log]].
  - In publishing a new version of the [[ref: DID Log]], the [[ref: DID
    Controller]] **SHOULD** remove the [[ref: witness]] [[ref: Data Integrity]] proofs from
    earlier [[ref: entries]] to reduce the size of the log. Only the set of approval
    proofs on the last [[ref: log entry]] are needed because of the chaining of the
    proofs via the use of the `entryHash` challenge.
  - Removing the prior entry [[ref: witness]] proofs does not affect the verifiability of
    the DID because the `entryHash` calculation does not include the `proof` property.
  - The specification leaves to implementers how the proofs are conveyed to
    the [[ref: DID Controller]].

As with the handling of the `updateKeys`, [[ref: DID Log Entry]] changes require
proofs from the the [[ref: witnesses]] active *prior* to the publication of a
new version. If a new version changes the list of [[ref: witnesses]], that
change must be approved by the *prior* [[ref: witnesses]]. For the first entry
in the [[ref: DID Log]], the [[ref: witnesses]] listed in that entry must
approve the version, since there are no "prior" [[ref: witnesses]].

The data model for the `witness` [[ref: parameter]] is as follows.
The threshold design borrows from the [[ref: verifiable conditions]]
specification.

```json
"witness" : {
  "threshold": n,
  "selfWeight": n,
  "witnesses" : [
      {
         "id": "<DID of witness>",
         "weight": n
      }
   ]
}
```

where:

- `threshold`: an integer that must be attained or surpassed by the sum of the [[ref: witnesses]] and
  [[ref: DID Controller]]'s weights for a [[ref: DID log entry]] to be considered approved.
- `selfWeight`: an integer that is the weight given the [[ref: DID Controller]]'s
  verified proof, in determining if the threshold has been surpassed.
- `witnesses`: an array of witnesses, each including the required fields:
  - `id`: the DID of the witness
  - `weight`: the weight of this [[ref: witness]]'s approval

The use of the threshold and weighted approvals (versus needing approvals from
all [[ref: witnesses]]) is to prevent faulty [[ref: witnesses]] from blocking the publishing of
a new version of the DID. To determine if the threshold has been passed, sum the
`weight` integer of the received approvals, plus the `selfWeight` of the [[ref: DID
Controller]], and if it equal to or more than `threshold`, the update can be
published. The calculation **MUST** also be executed by resolvers processing a
DID Log. For example, if there are three [[ref: witnesses]], each with a `weight` of 1,
the [[ref: DID Controller]] with a `selfWeight` of 2, and a `threshold` of 4, the
threshold will be met by two [[ref: witnesses]] approving the change, plus the [[ref: DID
Controller]].

If you want to learn about the practical application of witnesses, see the
Implementer's Guide section on
[Witnesses](https://didtdw.org/latest/implementers_guide/#witnesses) on the
`did:tdw` information site for more discussion on the witness capability and
using it in production scenarios.

#### Publishing a Parallel `did:web` DID

Each time a `did:tdw` version is created, the [[ref: DID Controller]] **MAY**
generate a corresponding `did:web` to publish along with the `did:tdw`. To do
so, the [[ref: DID Controller]] **MUST**:

1. Start with the resolved version of the [[ref: DIDDoc]] from `did:tdw`.
2. Execute a text replacement across the [[ref: DIDDoc]] of `did:tdw:<SCID>:` to
   `did:web:`, where `<scid>` is the actual `did:tdw` [[ref: SCID]].
3. Add to the [[ref: DIDDoc]] `alsoKnownAs` array, the full `did:tdw` DID. If the
   `alsoKnownAs` array does not exist in the [[ref: DIDDoc]], it **MUST** be added.
4. Publish the resulting [[ref: DIDDoc]] as the file `did.json` at the web location
   determined by the specified `did:web` DID-to-HTTPS transformation.

The benefit of doing this is that resolvers that have not been updated to
support `did:tdw` can continue to resolve the [[ref: DID Controller]]'s DIDs.
`did:web` resolvers that are aware of `did:tdw` features can use that knowledge,
and the existence of the `alsoKnownAs` `did:tdw` data in the [[ref: DIDDoc]] to get the
verifiable history of the DID.

The risk of publishing the `did:web` in parallel with the `did:tdw` is that the
added security and convenience of using `did:tdw` are lost.

### DID URL Resolution
The `did:tdw` DID Method embraces the power and usefulness of DID URLs, along
with the semantic simplicity of using them with a web-based DID method.
Specifically, a `did:tdw` implementation **MUST**:

- Resolve the `/whois` DID URL path using a [[spec:LINKED-VP]] service, whether
  or not it exists in the `did:tdw` [[ref: DIDDoc]], returning a [[ref:
  Verifiable Presentation]], if published by the [[ref: DID Controller]], found
  at the same path as the `did.jsonl` file (excluding the `.well-known` folder,
  if present), using the `/whois.vp` filename component, and the
  `application/vp' media type, as per the [IANA Verifiable Presentation
  Assignment](https://www.iana.org/assignments/media-types/application/vp).
  - For example, `did:tdw:{SCID}:example.com/whois` returns the
    [[ref: verifiable presentation]] from `https://example.com/whois.vp`.
- Resolve any `did:tdw` DID URL using a [[spec:DID-CORE]] `relativeRef` DID
  [[ref: parameter]], whether or not a supporting service exists in the `did:tdw` [[ref: DIDDoc]],
  returning the file found at web location corresponding to the DID-to-HTTPS
  transformation (excluding the `.well-known` folder, if present).
  - For example, resolving `did:{SCID}:tdw:example.com/governance/issuers.json` returns
    the file `https://example.com/governance/issuer.json`

In both cases, a [[ref: DID Controller]] **MAY** define services in the DIDDoc
that override the default services that **MUST** be resolved by the `did:tdw`
DID Method.

The sections below formalize the services that exist by default in `did:tdw` and
how a [[ref: DID Controller]] can override them.

#### whois LinkedVP Service

The `#whois` service enables those that receive a `did:tdw` DID to retrieve and
a [[ref: Verifiable Presentation]] (and embedded [[ref: Verifiable
Credentials]]) the [[ref: DID Controller]] has decided to publish about itself.
The intention is that anyone wanting to learn more about a particular `did:tdw`
DID can resolve the `<did>/whois` DID URL to retrieve a [[ref: Verifiable
Presentation]] published by the [[ref: DID Controller]] that contains [[ref:
Verifiable Credentials]] with the DID as the subject. The DID Controller
includes in the [[ref: Verifiable Presentation]] any [[ref: Verifiable Credentials]] that it
thinks might be helpful for resolvers in making a trust decision about the [[ref: DID
Controller]].

It is up to the [[ref: DID Controller]] to decide to publish a `whois`
[[ref: verifiable presentation]], and which [[ref: verifiable credentials]] to put into the
[[ref: verifiable presentation]]. It is up to a DID resolver to decide what attestations
from third parties are useful in making a trust decision about the [[ref: DID
Controller]].

`did:tdw` DIDs **automatically** supports a `/whois` service endpoint with the
following definition based on the [[spec:LINKED-VP]] specification, with the
`serviceEndpoint` defining a similar `did:tdw` DID-to-HTTPS DID Log
transformation with `did.jsonl` changed to `whois.vp`. Differing from the
[DID-to-HTTPS transformation](#the-did-to-https-transformation) is that the
`.well-known/` component of the `did.jsonl` transformation is dropped from the
`whois.vp` resolution.

```json
{
   "@context": "https://identity.foundation/linked-vp/contexts/v1",
   "id": "#whois",
   "type": "LinkedVerifiablePresentation",
   "serviceEndpoint": "<did-to-https-translation>/whois.vp"
}
```

The returned `whois.vp` **MUST** contain a [[ref: W3C VCDM]] [[ref: verifiable
presentation]] signed by the DID and containing [[ref: verifiable credentials]]
that **MUST** have the DID as the `credentialSubject`.

A [[ref: DID Controller]] **MAY** explicitly add to their [[ref: DIDDoc]] a `did:tdw`
service with the `"id": "#whois"`. Such an entry **MUST** override the implicit
`service` above. If the [[ref: DID Controller]] wants to publish the `whois`
[[ref: verifiable presentation]] in a different format than the [[ref: W3C
VCDM]] format, they **MUST** explicitly add to their [[ref: DIDDoc]] a service with the
`"id": "#whois"` to specify the name and implied format of the [[ref: verifiable
presentation]].

To resolve the DID URL `<did:tdw DID>/whois`, the resolver **MUST**:

1. Resolve the given `did:tdw` DID by retrieving, processing, and verifying the
   [[ref: DID log]] for the `did:tdw` as defined in this specification.
2. Find the [[ref: DIDDoc]] `service` with the `id` `#whois`, if any, or use the implicit
   service (above).
3. Resolve the `serviceEndpoint` URL, if possible, and return the document
   found.
   1. If the `serviceEndpoint` URL can't be resolved by the resolver (such as if
      the URL protocol is not supported by the resolver), the error `Error XXX:
      YYY` **MUST** be returned.
   2. If the file at the defined `serviceEndpoint` is not found, `Error
      404: Not Found` **MUST** be returned.

#### DID URL Path Resolution Service

The automatic resolution of `did:tdw` DID URL paths follows the
[[spec:DID-CORE]] `relativeRef` specification, as follows:

- a DID path, such as example 2 in [section 3.2 DID URL
  Syntax](https://www.w3.org/TR/did-core/#example-2) gives the example:
  `did:example:123456/resume.pdf`
- In turn, that can be treated as the following, as shown in example 8 in the
  same section: `did:example:123456?service=files&relativeRef=/resume.pdf`
- The `#files` service defined below then defines the `serviceEndpoint` for the
  `relativeRef`.
  - For `did:tdw`, that service is implicitly defined, with the
    `serviceEndpoint` matching the `did:tdw` [DID-to-HTTPS
    transformation](#the-did-to-https-transformation) and `did.jsonl` replaced
    by the DID URL Path. If `.well-known/` is part of the HTTPS URL, it is
    removed from the URL before resolving the URL.

Thus, the implicit service for DID `did:tdw:example.com:dids:<scid>` is:

```json
{
   "id": "#files",
   "type": "relativeRef",
   "serviceEndpoint": "https://example.com/dids/<scid>"
}
```

A [[ref: DID Controller]] **MAY** explicitly add to their [[ref: DIDDoc]] a service with
the `"id": "#files"`. Such an entry **MUST** override the implicit `service`
defined above.

To resolve the DID URL `<did:tdw DID>/path/to/file`, the resolver **MUST**:

1. Resolve the given `did:tdw` DID by retrieving, processing, and verifying the
   [[ref: DID log]] for the `did:tdw` as defined in this specification.
2. Find the [[ref: DIDDoc]] `service` with the `id` `#files`, if any, or use the implicit
   service (above).
3. Resolve the `serviceEndpoint` URL with the DID URL Path appended, if
   possible, and return the document found at that location.
   1. If the `serviceEndpoint` URL can't be resolved by the resolver (such as if
      the URL protocol is not supported by the resolver), the error `Error XXX:
      YYY` **MUST** be returned.
   2. If the file at the path appended to the defined `serviceEndpoint` is not
      found, the error `Error 404: Not Found` **MUST** be returned.
